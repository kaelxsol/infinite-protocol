<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>INFINITE — Dashboard</title>
<link rel="icon" type="image/png" href="/site/favicon.png">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=JetBrains+Mono:wght@300;400;500;700&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/site/shared.css">
<style>
/* ─── Layout ─── */
.app {
  display: grid;
  grid-template-columns: 260px 1fr;
  min-height: 100vh;
}

.app.connect-mode {
  grid-template-columns: 1fr;
}

/* ─── Sidebar ─── */
.sidebar {
  background: var(--surface);
  border-right: 1px solid var(--border);
  padding: 32px 24px;
  display: flex;
  flex-direction: column;
  position: sticky;
  top: 0;
  height: 100vh;
}

.sidebar-logo {
  font-family: var(--font-mono);
  font-weight: 700;
  font-size: 13px;
  letter-spacing: 3px;
  color: var(--accent);
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 48px;
  padding-bottom: 24px;
  border-bottom: 1px solid var(--border);
}

.sidebar-logo .inf { font-size: 22px; }

.sidebar-nav { flex: 1; overflow-y: auto; }

.nav-group-label {
  font-family: var(--font-mono);
  font-size: 9px;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 12px;
  margin-top: 28px;
}

.nav-group-label:first-child { margin-top: 0; }

.nav-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 14px;
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-dim);
  cursor: pointer;
  border-radius: 6px;
  transition: all 0.2s;
  margin-bottom: 2px;
  letter-spacing: 0.5px;
}

.nav-item:hover { background: var(--surface-2); color: var(--text); }
.nav-item.active { background: var(--surface-2); color: var(--accent); }
.nav-item .icon { font-size: 14px; width: 20px; text-align: center; }

.sidebar-footer {
  padding-top: 24px;
  border-top: 1px solid var(--border);
}

.sidebar-socials {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}

.sidebar-social-link {
  flex: 1;
  font-family: var(--font-mono);
  font-size: 10px;
  letter-spacing: 0.5px;
  text-align: center;
  padding: 6px 0;
  color: var(--text-muted);
  border: 1px solid var(--border);
  border-radius: 4px;
  text-decoration: none;
  transition: all 0.2s;
}

.sidebar-social-link:hover {
  color: var(--accent);
  border-color: var(--accent);
}

.wallet-info {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  margin-bottom: 8px;
}

.wallet-addr {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-dim);
  background: var(--bg);
  padding: 8px 12px;
  border: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  transition: border-color 0.2s;
}

.wallet-addr:hover { border-color: var(--accent); }
.wallet-addr .copy { color: var(--accent); font-size: 10px; }

/* ─── Main ─── */
.main {
  padding: 40px;
  overflow-y: auto;
}

.main.chat-mode {
  padding: 0;
  display: flex;
  flex-direction: column;
}

.page-header { margin-bottom: 40px; }

.page-title {
  font-family: var(--font-display);
  font-size: 36px;
  margin-bottom: 8px;
}

.page-sub {
  font-size: 14px;
  color: var(--text-dim);
  font-weight: 300;
}

/* ─── Stats ─── */
.stats-row { margin-bottom: 40px; }

.stat-card .label {
  font-family: var(--font-mono);
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 8px;
}

.stat-card .value {
  font-family: var(--font-mono);
  font-size: 28px;
  font-weight: 700;
  color: var(--text);
}

.stat-card .value.accent { color: var(--accent); }
.stat-card .value.green { color: var(--green); }

.stat-card .sub {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
  margin-top: 4px;
}

/* ─── Sections ─── */
.section { margin-bottom: 40px; }

.section-title {
  font-family: var(--font-mono);
  font-size: 11px;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--accent);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.section-title::before {
  content: '';
  width: 24px;
  height: 1px;
  background: var(--accent);
}

.api-key-box {
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 24px;
}

.api-key-display {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}

.api-key-value {
  flex: 1;
  font-family: var(--font-mono);
  font-size: 14px;
  color: var(--text);
  background: var(--bg);
  padding: 14px 18px;
  border: 1px solid var(--border);
  letter-spacing: 1px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.api-key-actions { display: flex; gap: 8px; }

.api-key-hint {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  line-height: 1.6;
}

.api-key-hint code {
  background: var(--bg);
  padding: 2px 6px;
  border: 1px solid var(--border);
  font-size: 10px;
  color: var(--text-dim);
}

/* ─── Usage Bar ─── */
.usage-bar-container {
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 24px;
}

.usage-header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 16px;
}

.usage-count {
  font-family: var(--font-mono);
  font-size: 14px;
  color: var(--text);
}

.usage-count span { color: var(--text-muted); }

.usage-bar-track {
  height: 8px;
  background: var(--bg);
  border: 1px solid var(--border);
  position: relative;
  overflow: hidden;
  margin-bottom: 12px;
}

.usage-bar-fill {
  height: 100%;
  background: var(--accent);
  transition: width 1s ease-out;
}

.usage-bar-fill.warning { background: #febc2e; }
.usage-bar-fill.danger { background: var(--red); }

.usage-legend { display: flex; gap: 24px; }

.usage-legend-item {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 6px;
}

.usage-legend-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

/* ─── Chat UI ─── */
.chat-container {
  display: flex;
  flex-direction: column;
  height: 100vh;
  max-height: 100vh;
  min-height: 0;
  overflow: hidden;
}

.chat-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 24px;
  border-bottom: 1px solid var(--border);
  background: var(--surface);
  flex-shrink: 0;
}

.chat-header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.chat-model-select {
  font-family: var(--font-mono);
  font-size: 12px;
  background: var(--bg);
  color: var(--text);
  border: 1px solid var(--border);
  padding: 8px 12px;
  cursor: pointer;
  letter-spacing: 0.5px;
  outline: none;
}

.chat-model-select:focus { border-color: var(--accent); }

.chat-model-select option {
  background: var(--bg);
  color: var(--text);
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 24px;
  scroll-behavior: smooth;
}

.chat-empty {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  flex: 1;
  text-align: center;
  min-height: 400px;
}

.chat-empty-icon {
  font-size: 64px;
  color: var(--accent);
  opacity: 0.3;
  margin-bottom: 24px;
  font-family: var(--font-display);
}

.chat-empty-title {
  font-family: var(--font-display);
  font-size: 28px;
  margin-bottom: 8px;
}

.chat-empty-sub {
  font-size: 14px;
  color: var(--text-dim);
  font-weight: 300;
  max-width: 400px;
}

.chat-message {
  display: flex;
  gap: 16px;
  max-width: 800px;
  width: 100%;
  margin: 0 auto;
  animation: fadeUp 0.3s ease;
}

.chat-msg-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  flex-shrink: 0;
  margin-top: 2px;
}

.chat-message.user .chat-msg-avatar {
  background: var(--surface-2);
  border: 1px solid var(--border);
  color: var(--text-dim);
}

.chat-message.assistant .chat-msg-avatar {
  background: var(--accent);
  color: var(--bg);
  font-weight: 700;
}

.chat-msg-body { flex: 1; min-width: 0; }

.chat-msg-name {
  font-family: var(--font-mono);
  font-size: 10px;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 6px;
}

.chat-msg-content {
  font-size: 14px;
  line-height: 1.7;
  color: var(--text);
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.chat-msg-content.error { color: var(--red); }

/* Chat markdown rendering */
.chat-msg-content strong { font-weight: 600; }
.chat-msg-content em { font-style: italic; color: var(--text-dim); }

.chat-msg-content code:not(pre code) {
  font-family: var(--font-mono);
  font-size: 12px;
  background: var(--surface-2);
  border: 1px solid var(--border);
  padding: 2px 6px;
  border-radius: 3px;
  color: var(--accent);
}

.chat-msg-content pre {
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 16px;
  margin: 12px 0;
  overflow-x: auto;
  font-family: var(--font-mono);
  font-size: 12px;
  line-height: 1.6;
  color: var(--text-dim);
  position: relative;
}

.chat-msg-content pre .code-lang {
  position: absolute;
  top: 8px;
  right: 12px;
  font-size: 9px;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--text-muted);
}

.chat-msg-content pre .code-copy {
  position: absolute;
  top: 6px;
  right: 60px;
  font-family: var(--font-mono);
  font-size: 9px;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--accent);
  background: none;
  border: 1px solid var(--border);
  padding: 3px 8px;
  cursor: pointer;
  transition: all 0.2s;
}

.chat-msg-content pre .code-copy:hover {
  border-color: var(--accent);
  background: var(--surface-2);
}

.chat-msg-content pre code {
  font-family: inherit;
  font-size: inherit;
  background: none;
  border: none;
  padding: 0;
  color: inherit;
}

.chat-msg-content ul, .chat-msg-content ol {
  padding-left: 24px;
  margin: 8px 0;
}

.chat-msg-content li { margin-bottom: 4px; }

.chat-msg-content h1, .chat-msg-content h2, .chat-msg-content h3 {
  font-family: var(--font-display);
  margin: 16px 0 8px;
}

.chat-msg-content h1 { font-size: 24px; }
.chat-msg-content h2 { font-size: 20px; }
.chat-msg-content h3 { font-size: 16px; }

.chat-msg-content blockquote {
  border-left: 3px solid var(--accent);
  padding-left: 16px;
  margin: 12px 0;
  color: var(--text-dim);
}

.chat-typing {
  display: flex;
  gap: 4px;
  padding: 8px 0;
}

.typing-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--accent);
  animation: typingBounce 1.2s ease-in-out infinite;
}

.typing-dot:nth-child(2) { animation-delay: 0.15s; }
.typing-dot:nth-child(3) { animation-delay: 0.3s; }

@keyframes typingBounce {
  0%, 80%, 100% { opacity: 0.3; transform: translateY(0); }
  40% { opacity: 1; transform: translateY(-4px); }
}

/* ─── Tool Indicators ─── */
.tool-indicator {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 14px;
  border: 1px solid rgba(200, 255, 0, 0.15);
  border-radius: 6px;
  background: rgba(200, 255, 0, 0.03);
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-dim);
  margin: 4px 0;
  animation: fadeUp 0.3s ease;
}

.tool-spinner {
  width: 14px;
  height: 14px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  flex-shrink: 0;
}

.search-sources {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin: 6px 0 10px;
  animation: fadeUp 0.3s ease;
}

.search-source-chip {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-dim);
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 4px 10px;
  border-radius: 3px;
  text-decoration: none;
  transition: all 0.2s;
  max-width: 200px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.search-source-chip:hover {
  border-color: var(--accent);
  color: var(--accent);
}

.search-source-chip::before {
  content: '';
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--accent);
  flex-shrink: 0;
}

/* ─── Tool Result Cards ─── */
.tool-result-card {
  display: flex;
  flex-direction: column;
  gap: 6px;
  padding: 10px 14px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--surface);
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-dim);
  margin: 6px 0;
  animation: fadeUp 0.3s ease;
  max-width: 600px;
}

.tool-result-card .trc-header {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 10px;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--text-muted);
}

.tool-result-card .trc-icon {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--accent);
  flex-shrink: 0;
}

.tool-result-card .trc-title {
  color: var(--text);
  font-size: 12px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.tool-result-card .trc-title a {
  color: var(--accent);
  text-decoration: none;
}

.tool-result-card .trc-title a:hover { text-decoration: underline; }

.tool-result-card .trc-body {
  color: var(--text-dim);
  font-size: 11px;
  line-height: 1.5;
  max-height: 80px;
  overflow: hidden;
}

.tool-result-card .trc-body.code-output {
  background: var(--bg);
  padding: 8px;
  border-radius: 4px;
  font-size: 10px;
  max-height: 120px;
  overflow-y: auto;
  white-space: pre-wrap;
  word-break: break-all;
}

.tool-result-card .trc-meta {
  display: flex;
  gap: 12px;
  font-size: 9px;
  color: var(--text-muted);
}

.tool-result-card .trc-error {
  color: #ff6b6b;
}

.tool-result-card .trc-stats {
  display: flex;
  gap: 16px;
  font-size: 10px;
}

.tool-result-card .trc-stat {
  color: var(--text-muted);
}

.tool-result-card .trc-stat span { color: var(--text); }

/* ─── Chat Upload ─── */
.chat-upload-btn {
  width: 50px;
  height: 50px;
  background: var(--bg);
  border: 1px solid var(--border);
  color: var(--text-dim);
  font-size: 20px;
  font-weight: 300;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: all 0.2s;
}

.chat-upload-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
}

.chat-connectors-btn {
  position: relative;
}

.connectors-dot {
  position: absolute;
  top: 6px;
  right: 6px;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--accent);
}

.chat-image-preview {
  display: flex;
  gap: 8px;
  padding: 8px 24px 0;
  max-width: 848px;
  width: 100%;
  margin: 0 auto;
  flex-wrap: wrap;
}

.chat-image-thumb {
  position: relative;
  width: 60px;
  height: 60px;
  border: 1px solid var(--border);
  border-radius: 4px;
  overflow: hidden;
}

.chat-image-thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.chat-image-thumb .remove-img {
  position: absolute;
  top: 2px;
  right: 2px;
  width: 16px;
  height: 16px;
  background: rgba(0,0,0,0.7);
  color: #fff;
  font-size: 10px;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
}

/* ─── Tool Toggle ─── */
.tool-toggle {
  font-family: var(--font-mono);
  font-size: 10px;
  letter-spacing: 0.5px;
  padding: 6px 12px;
  background: var(--bg);
  color: var(--text-muted);
  border: 1px solid var(--border);
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}

.tool-toggle.active {
  border-color: var(--accent);
  color: var(--accent);
  background: rgba(200, 255, 0, 0.05);
}

.tool-toggle:hover { border-color: var(--accent); }

.tool-toggle-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--text-muted);
  transition: background 0.2s;
}

.tool-toggle.active .tool-toggle-dot { background: var(--accent); }

/* ─── Connections ─── */
.connections-grid {
  display: grid;
  gap: 16px;
  max-width: 700px;
}

.connection-card {
  display: flex;
  align-items: center;
  gap: 20px;
  padding: 24px;
}

.connection-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  background: var(--bg);
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-mono);
  font-weight: 700;
  font-size: 16px;
  color: var(--accent);
  flex-shrink: 0;
}

.connection-info {
  flex: 1;
  min-width: 0;
}

.connection-name {
  font-weight: 600;
  font-size: 15px;
  margin-bottom: 4px;
}

.connection-desc {
  font-size: 13px;
}

.connection-action {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
}

.connection-status.connected {
  font-family: var(--font-mono);
  font-size: 11px;
  letter-spacing: 0.5px;
  color: var(--accent);
}

.connection-card.coming-soon {
  opacity: 0.5;
}

.coming-soon-label {
  font-family: var(--font-mono);
  font-size: 11px;
  letter-spacing: 0.5px;
  color: var(--text-muted);
}

/* ─── Chat Images in Messages ─── */
.chat-msg-images {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 8px;
}

.chat-msg-images img {
  max-width: 200px;
  max-height: 150px;
  border: 1px solid var(--border);
  border-radius: 4px;
  object-fit: cover;
}

.chat-input-area {
  display: flex;
  align-items: flex-end;
  gap: 12px;
  padding: 16px 24px;
  border-top: 1px solid var(--border);
  background: var(--surface);
  flex-shrink: 0;
  max-width: 848px;
  width: 100%;
  margin: 0 auto;
}

.chat-input {
  flex: 1;
  font-family: var(--font-body);
  font-size: 14px;
  color: var(--text);
  background: var(--bg);
  border: 1px solid var(--border);
  padding: 14px 18px;
  resize: none;
  outline: none;
  min-height: 50px;
  max-height: 200px;
  line-height: 1.5;
  transition: border-color 0.2s;
}

.chat-input:focus { border-color: var(--accent); }

.chat-input::placeholder { color: var(--text-muted); }

.chat-send-btn {
  font-family: var(--font-mono);
  font-size: 16px;
  width: 50px;
  height: 50px;
  background: var(--accent);
  color: var(--bg);
  border: none;
  cursor: pointer;
  font-weight: 700;
  transition: all 0.2s;
  flex-shrink: 0;
}

.chat-send-btn:hover { background: #fff; }
.chat-send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

/* ─── Image Lab ─── */
.image-prompt-area {
  display: flex;
  gap: 12px;
  margin-bottom: 32px;
}

.image-prompt-input {
  flex: 1;
  font-family: var(--font-body);
  font-size: 14px;
  color: var(--text);
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 16px 20px;
  outline: none;
  transition: border-color 0.2s;
}

.image-prompt-input:focus { border-color: var(--accent); }
.image-prompt-input::placeholder { color: var(--text-muted); }

.image-gen-btn {
  font-family: var(--font-mono);
  font-size: 11px;
  letter-spacing: 2px;
  text-transform: uppercase;
  padding: 16px 32px;
  background: var(--accent);
  color: var(--bg);
  border: none;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
  white-space: nowrap;
}

.image-gen-btn:hover { background: #fff; }
.image-gen-btn:disabled { opacity: 0.4; cursor: not-allowed; }

.image-gallery {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 16px;
}

.image-card {
  background: var(--surface);
  border: 1px solid var(--border);
  overflow: hidden;
  transition: border-color 0.3s;
}

.image-card:hover { border-color: var(--accent); }

.image-card img {
  width: 100%;
  display: block;
}

.image-card-footer {
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.image-card-prompt {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-dim);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex: 1;
  margin-right: 12px;
}

.image-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 80px 0;
  color: var(--text-muted);
}

.image-spinner {
  width: 32px;
  height: 32px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-bottom: 16px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ─── Tools Hub ─── */
.tools-section { margin-bottom: 40px; }

.tool-config-box {
  background: var(--bg);
  border: 1px solid var(--border);
  padding: 14px 16px;
  margin-top: 12px;
  font-family: var(--font-mono);
  font-size: 11px;
  line-height: 1.6;
  color: var(--text-dim);
  white-space: pre;
  overflow-x: auto;
}

.tool-card-actions {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}

.tool-card-actions a {
  font-family: var(--font-mono);
  font-size: 9px;
  letter-spacing: 1px;
  text-transform: uppercase;
  padding: 6px 12px;
  border: 1px solid var(--border-light);
  color: var(--text-dim);
  text-decoration: none;
  transition: all 0.2s;
}

.tool-card-actions a:hover {
  border-color: var(--accent);
  color: var(--accent);
}

/* ─── Future APIs ─── */
.future-apis-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: 20px;
  margin-top: 24px;
}

.api-card {
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 20px;
  transition: all 0.2s;
  display: flex;
  gap: 16px;
}

.api-card:hover {
  border-color: var(--accent);
}

.api-card-logo {
  width: 48px;
  height: 48px;
  border-radius: 10px;
  background: var(--surface-2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  flex-shrink: 0;
  overflow: hidden;
}

.api-card-logo img {
  width: 40px;
  height: 40px;
  object-fit: contain;
  border-radius: 8px;
}

.api-card-content {
  flex: 1;
  min-width: 0;
}

.api-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}

.api-card-name {
  font-family: var(--font-mono);
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
}

.api-card-category {
  font-family: var(--font-mono);
  font-size: 9px;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--accent);
  background: var(--accent-glow);
  padding: 3px 8px;
  border-radius: 3px;
}

.api-card-desc {
  font-size: 12px;
  color: var(--text-dim);
  line-height: 1.5;
  margin-bottom: 12px;
}

.api-card-features {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 12px;
}

.api-card-feature {
  font-family: var(--font-mono);
  font-size: 9px;
  color: var(--text-muted);
  background: var(--bg);
  border: 1px solid var(--border);
  padding: 4px 8px;
}

.api-card-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding-top: 12px;
  border-top: 1px solid var(--border);
}

.api-card-link {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
  text-decoration: none;
  transition: color 0.2s;
}

.api-card-link:hover {
  color: var(--accent);
}

.api-upvote-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  font-family: var(--font-mono);
  font-size: 12px;
  padding: 6px 12px;
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-dim);
  cursor: pointer;
  transition: all 0.2s;
}

.api-upvote-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
}

.api-upvote-btn.voted {
  background: var(--accent-glow);
  border-color: var(--accent);
  color: var(--accent);
}

.api-upvote-btn .arrow {
  font-size: 14px;
}

.future-apis-note {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 16px;
  margin-bottom: 24px;
  line-height: 1.6;
}

.future-apis-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.future-apis-tab {
  font-family: var(--font-mono);
  font-size: 10px;
  letter-spacing: 1px;
  text-transform: uppercase;
  padding: 8px 16px;
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-dim);
  cursor: pointer;
  transition: all 0.2s;
}

.future-apis-tab:hover {
  border-color: var(--text-dim);
}

.future-apis-tab.active {
  background: var(--accent);
  border-color: var(--accent);
  color: var(--bg);
}

/* ─── Connect Screen ─── */
.connect-screen {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 40px;
  position: relative;
}

.connect-screen::before {
  content: '';
  position: absolute;
  width: 500px;
  height: 500px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(200, 255, 0, 0.04) 0%, transparent 70%);
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
}

.connect-box {
  text-align: center;
  max-width: 440px;
  position: relative;
  z-index: 1;
}

.connect-box .logo {
  font-family: var(--font-display);
  font-size: 56px;
  font-style: italic;
  color: var(--accent);
  margin-bottom: 28px;
  line-height: 1;
}

.connect-box h1 {
  font-family: var(--font-display);
  font-size: 36px;
  margin-bottom: 12px;
  letter-spacing: -0.5px;
}

.connect-box p {
  font-size: 14px;
  color: var(--text-dim);
  margin-bottom: 36px;
  font-weight: 300;
  line-height: 1.7;
}

.connect-btn {
  font-family: var(--font-mono);
  font-size: 13px;
  letter-spacing: 2px;
  text-transform: uppercase;
  padding: 16px 48px;
  background: var(--accent);
  color: var(--bg);
  border: 1px solid var(--accent);
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
  width: 100%;
  margin-bottom: 12px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.connect-btn:hover {
  background: #fff;
  border-color: #fff;
  transform: translateY(-1px);
}

.connect-btn-secondary {
  background: transparent;
  color: var(--text);
  border: 1px solid var(--border-light);
}

.connect-btn-secondary:hover {
  background: var(--surface-2);
  border-color: var(--accent);
  color: var(--accent);
}

.connect-wallets { margin-bottom: 20px; }

.connect-error {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--red);
  padding: 12px 16px;
  border: 1px solid rgba(255, 95, 87, 0.3);
  background: rgba(255, 95, 87, 0.05);
  margin-bottom: 20px;
  line-height: 1.5;
  text-align: left;
}

.connect-note {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
  letter-spacing: 0.5px;
}

/* ─── Video Lab ─── */
.video-controls {
  display: grid;
  grid-template-columns: 1fr auto auto auto;
  gap: 12px;
  margin-bottom: 32px;
  align-items: end;
}

.video-select {
  font-family: var(--font-mono);
  font-size: 12px;
  background: var(--surface);
  color: var(--text);
  border: 1px solid var(--border);
  padding: 14px 12px;
  cursor: pointer;
  outline: none;
}

.video-select:focus { border-color: var(--accent); }

.video-card {
  background: var(--surface);
  border: 1px solid var(--border);
  overflow: hidden;
  transition: border-color 0.3s;
}

.video-card:hover { border-color: var(--accent); }

.video-card video {
  width: 100%;
  display: block;
  background: #000;
}

.video-card-footer {
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.video-card-prompt {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-dim);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex: 1;
  margin-right: 12px;
}

.video-pending {
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 40px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
  min-height: 200px;
}

.video-pending .image-spinner { margin-bottom: 0; }

.video-tier-gate {
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 60px 40px;
  text-align: center;
}

.video-tier-gate h3 {
  font-family: var(--font-display);
  font-size: 24px;
  margin-bottom: 12px;
}

.video-tier-gate p {
  font-size: 14px;
  color: var(--text-dim);
  margin-bottom: 4px;
}

/* ─── Trade Bot Panel ─── */
.bot-layout {
  display: grid;
  grid-template-columns: 280px 1fr;
  gap: 0;
  flex: 1;
  min-height: 0;
  height: 100vh;
  max-height: 100vh;
}

.bot-sidebar {
  background: var(--surface);
  border-right: 1px solid var(--border);
  padding: 16px 12px;
  overflow-y: auto;
  min-height: 0;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.bot-card {
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--bg);
}

.bot-card-title {
  font-family: var(--font-mono);
  font-size: 9px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.bot-card-title .badge {
  font-size: 8px;
  padding: 2px 6px;
  border-radius: 3px;
  letter-spacing: 1px;
  font-weight: 600;
}

.badge-live { background: rgba(200, 255, 0, 0.15); color: var(--accent); }
.badge-paused { background: rgba(255, 200, 0, 0.15); color: #ffcc00; }
.badge-stopped { background: rgba(255, 95, 87, 0.15); color: var(--red); }

.bot-wallet-addr {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text);
  word-break: break-all;
  margin-bottom: 8px;
}

.bot-wallet-bal {
  font-family: var(--font-mono);
  font-size: 18px;
  font-weight: 600;
  color: var(--accent);
  margin-bottom: 4px;
}

.bot-wallet-bal-label {
  font-family: var(--font-mono);
  font-size: 9px;
  color: var(--text-muted);
  letter-spacing: 1px;
}

.bot-wallet-actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px;
  margin-top: 10px;
}

.bot-wallet-action-btn {
  font-family: var(--font-mono);
  font-size: 9px;
  font-weight: 500;
  letter-spacing: 0.5px;
  padding: 6px 8px;
  background: var(--surface);
  color: var(--text-dim);
  border: 1px solid var(--border);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.bot-wallet-action-btn:hover { border-color: var(--accent); color: var(--accent); }

.bot-quick-trade {
  display: grid;
  grid-template-columns: 1fr;
  gap: 6px;
}

.bot-input {
  font-family: var(--font-mono);
  font-size: 10px;
  background: var(--surface);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 8px 10px;
  outline: none;
  width: 100%;
}

.bot-input:focus { border-color: var(--accent); }

.bot-trade-btns {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px;
}

.bot-btn-buy, .bot-btn-sell {
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 1px;
  padding: 10px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  text-align: center;
  transition: all 0.2s;
}

.bot-btn-buy { background: rgba(0, 200, 83, 0.2); color: var(--green); }
.bot-btn-buy:hover { background: rgba(0, 200, 83, 0.35); }
.bot-btn-sell { background: rgba(255, 95, 87, 0.2); color: var(--red); }
.bot-btn-sell:hover { background: rgba(255, 95, 87, 0.35); }

.bot-nav-list { display: flex; flex-direction: column; gap: 2px; }

.bot-nav-item {
  font-family: var(--font-mono);
  font-size: 11px;
  padding: 8px 10px;
  border-radius: 4px;
  cursor: pointer;
  color: var(--text-dim);
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.2s;
}

.bot-nav-item:hover { background: var(--surface-2); color: var(--text); }
.bot-nav-item.active { background: var(--surface-2); color: var(--accent); }

.bot-nav-count {
  font-size: 9px;
  background: var(--surface-2);
  color: var(--text-muted);
  padding: 1px 6px;
  border-radius: 3px;
  min-width: 18px;
  text-align: center;
}

.bot-pnl {
  font-family: var(--font-mono);
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 4px;
}

.bot-pnl.positive { color: var(--green); }
.bot-pnl.negative { color: var(--red); }

.bot-kill-btn {
  width: 100%;
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  padding: 10px;
  background: rgba(255, 95, 87, 0.15);
  color: var(--red);
  border: 1px solid rgba(255, 95, 87, 0.3);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}

.bot-kill-btn:hover { background: rgba(255, 95, 87, 0.3); }

.bot-resume-btn {
  width: 100%;
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  padding: 10px;
  background: rgba(0, 200, 83, 0.15);
  color: var(--green);
  border: 1px solid rgba(0, 200, 83, 0.3);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}

.bot-resume-btn:hover { background: rgba(0, 200, 83, 0.3); }

/* ─── Bot Main Panel ─── */
.bot-main {
  padding: 32px;
  overflow-y: auto;
  min-height: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.bot-main > * {
  width: 100%;
  max-width: 640px;
}

.bot-main h2 {
  font-family: var(--font-mono);
  font-size: 11px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 20px;
}

.bot-positions-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 12px;
  margin-bottom: 24px;
}

.bot-position-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 14px;
}

.bot-position-token {
  font-family: var(--font-mono);
  font-size: 12px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 4px;
}

.bot-position-mint {
  font-family: var(--font-mono);
  font-size: 9px;
  color: var(--text-muted);
  margin-bottom: 8px;
  word-break: break-all;
}

.bot-position-stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px;
}

.bot-position-stat {
  font-family: var(--font-mono);
  font-size: 9px;
}

.bot-position-stat .label {
  color: var(--text-muted);
  letter-spacing: 1px;
  text-transform: uppercase;
  margin-bottom: 2px;
}

.bot-position-stat .val { color: var(--text); font-size: 11px; }

.bot-form {
  display: flex;
  flex-direction: column;
  gap: 12px;
  width: 100%;
}

.bot-form-row {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.bot-form-label {
  font-family: var(--font-mono);
  font-size: 9px;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--text-muted);
}

.bot-form-input {
  font-family: var(--font-mono);
  font-size: 11px;
  background: var(--surface);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 10px 12px;
  outline: none;
}

.bot-form-input:focus { border-color: var(--accent); }

.bot-form-submit {
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 1px;
  padding: 12px;
  background: var(--accent);
  color: var(--bg);
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}

.bot-form-submit:hover { opacity: 0.9; }

.bot-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.bot-list-item {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 12px 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.bot-list-info {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text);
}

.bot-list-sub {
  font-family: var(--font-mono);
  font-size: 9px;
  color: var(--text-muted);
  margin-top: 2px;
}

.bot-list-action {
  font-family: var(--font-mono);
  font-size: 9px;
  font-weight: 600;
  padding: 4px 10px;
  border-radius: 3px;
  cursor: pointer;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-dim);
  transition: all 0.2s;
}

.bot-list-action:hover { border-color: var(--red); color: var(--red); }

.bot-history-table {
  width: 100%;
  border-collapse: collapse;
  font-family: var(--font-mono);
  font-size: 10px;
}

.bot-history-table th {
  text-align: left;
  padding: 8px 10px;
  color: var(--text-muted);
  font-size: 9px;
  letter-spacing: 1px;
  text-transform: uppercase;
  border-bottom: 1px solid var(--border);
}

.bot-history-table td {
  padding: 8px 10px;
  color: var(--text-dim);
  border-bottom: 1px solid var(--border);
}

.bot-empty {
  text-align: center;
  padding: 48px 24px;
  color: var(--text-muted);
  font-family: var(--font-mono);
  font-size: 11px;
}

.bot-empty-icon {
  font-size: 32px;
  margin-bottom: 12px;
  opacity: 0.3;
}

/* ─── Portfolio ─── */
.portfolio-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 12px;
  margin-bottom: 24px;
}

.portfolio-stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 14px;
}

.portfolio-stat-card .label {
  font-family: var(--font-mono);
  font-size: 9px;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 6px;
}

.portfolio-stat-card .val {
  font-family: var(--font-mono);
  font-size: 18px;
  font-weight: 600;
  color: var(--text);
}

.portfolio-stat-card .val.accent { color: var(--accent); }

.portfolio-holdings {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.portfolio-row {
  display: grid;
  grid-template-columns: 1fr auto auto;
  gap: 16px;
  align-items: center;
  padding: 10px 14px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  font-family: var(--font-mono);
  font-size: 11px;
  cursor: pointer;
  transition: border-color 0.2s;
}

.portfolio-row:hover { border-color: var(--accent); }

.portfolio-row .token-mint {
  font-size: 9px;
  color: var(--text-muted);
  margin-top: 2px;
}

.portfolio-row .token-amount { color: var(--text); text-align: right; }
.portfolio-row .token-value { color: var(--text-dim); text-align: right; font-size: 10px; }

.portfolio-sol-row {
  display: grid;
  grid-template-columns: 1fr auto auto;
  gap: 16px;
  align-items: center;
  padding: 12px 14px;
  background: var(--surface);
  border: 1px solid var(--accent);
  border-radius: 6px;
  font-family: var(--font-mono);
  font-size: 11px;
  margin-bottom: 8px;
}

.portfolio-sol-row .token-amount { color: var(--accent); font-weight: 600; text-align: right; }
.portfolio-sol-row .token-value { color: var(--text-dim); text-align: right; font-size: 10px; }

/* ─── Chat Quick Actions Sidebar ─── */
.chat-with-sidebar {
  display: grid;
  grid-template-columns: 1fr 220px;
  gap: 0;
  flex: 1;
  min-height: 0;
  height: 100vh;
  max-height: 100vh;
}

.chat-qa-sidebar {
  background: var(--surface);
  border-left: 1px solid var(--border);
  padding: 16px 12px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.token-info-card {
  margin-top: 10px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 12px;
}

.token-info-header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 10px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
}

.token-info-name {
  font-family: var(--font-mono);
  font-size: 12px;
  font-weight: 600;
  color: var(--text);
}

.token-info-symbol {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--accent);
  letter-spacing: 0.5px;
}

.token-info-stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px 16px;
}

.token-info-stat {
  font-family: var(--font-mono);
  font-size: 9px;
}

.token-info-stat .label {
  color: var(--text-muted);
  margin-bottom: 3px;
  letter-spacing: 1px;
  text-transform: uppercase;
}

.token-info-stat .val { color: var(--text); font-size: 12px; font-weight: 500; }
.token-info-stat .val.green { color: var(--green); }
.token-info-stat .val.red { color: var(--red); }

.trading-quick-btns {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px;
}

.trading-quick-btn {
  font-family: var(--font-mono);
  font-size: 10px;
  letter-spacing: 0.5px;
  padding: 8px 6px;
  background: var(--surface);
  color: var(--text-dim);
  border: 1px solid var(--border);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.trading-quick-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
  background: rgba(200, 255, 0, 0.04);
}

.trading-token-input {
  display: flex;
  gap: 6px;
}

.trading-token-input input {
  flex: 1;
  min-width: 0;
  font-family: var(--font-mono);
  font-size: 10px;
  background: var(--surface);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 8px 10px;
  outline: none;
}

.trading-token-input input:focus { border-color: var(--accent); }

/* ─── Responsive ─── */
@media (max-width: 900px) {
  .app { grid-template-columns: 1fr; }
  .sidebar { display: none; }
  .chat-input-area { max-width: 100%; }
  .image-prompt-area { flex-direction: column; }
  .video-controls { grid-template-columns: 1fr; }
  .bot-layout { grid-template-columns: 1fr; }
  .bot-sidebar { display: none; }
  .chat-with-sidebar { grid-template-columns: 1fr; }
  .chat-qa-sidebar { display: none; }
}
</style>
</head>
<body>

<div class="app" id="app"></div>

<script>
// ═══════════════════════════════════════════
// INFINITE Dashboard
// ═══════════════════════════════════════════

const API_BASE = window.location.hostname === 'localhost'
  ? 'http://localhost:3001'
  : '/proxy';

const STORAGE_KEY = 'infinite_session';
const CHAT_STORAGE_KEY = 'infinite_chats';

// ─── State ───

const STATE = {
  connected: false,
  connecting: false,
  wallet: null,
  walletProvider: null,
  apiKey: null,
  apiKeyFull: null,
  tier: null,
  balance: 0,
  usage: { today: 0, limit: 0, remaining: 0 },
  models: [],
  treasury: { healthStatus: 'unknown', runwayDays: 0, multiplier: 1.0, treasuryBalanceUsd: 0, treasuryBalanceSol: 0, solPrice: 0 },
  providers: { claude: false, gemini: false, openai: false },
  connections: { github: false, google: false, notion: false },
  activeTab: 'overview',
  keyVisible: false,
  error: null,
};

const CHAT = {
  conversations: [],
  activeId: null,
  selectedModel: '',
  isGenerating: false,
  abortController: null,
  enabledTools: ['web_search'],
  pendingImages: [],
};

const IMAGES = {
  gallery: [],
  isGenerating: false,
};

const VIDEOS = {
  gallery: [],
  isGenerating: false,
  pollIntervals: new Map(),
};

const TRADING = {
  conversations: [],
  activeId: null,
  selectedModel: '',
  isGenerating: false,
  abortController: null,
  tokenInfo: null,
  // Bot state
  wallet: null,
  portfolio: null,
  positions: [],
  dcaOrders: [],
  copyTargets: [],
  triggers: [],
  safety: null,
  history: [],
  activePanel: 'portfolio',
  pollInterval: null,
};

const VOTES = {
  userVotes: new Set(),
  voteCounts: {},
};

async function loadVotes() {
  try {
    const data = await api('/votes');
    VOTES.voteCounts = data.counts || {};
    VOTES.userVotes = new Set(data.userVotes || []);
    render();
  } catch (e) { console.error('Failed to load votes:', e); }
}

async function toggleVote(apiId) {
  if (!STATE.connected) {
    STATE.error = 'Connect your wallet to vote';
    render();
    return;
  }
  try {
    const data = await api('/votes', { method: 'POST', body: JSON.stringify({ apiId }) });
    VOTES.voteCounts = data.counts || {};
    VOTES.userVotes = new Set(data.userVotes || []);
    render();
  } catch (e) {
    console.error('Failed to toggle vote:', e);
    STATE.error = e.message || 'Failed to vote';
    render();
  }
}

loadVotes();

let statusPollInterval = null;

// ─── Wallet Icons ───

const WALLET_ICONS = {
  phantom: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDgiIGhlaWdodD0iMTA4IiB2aWV3Qm94PSIwIDAgMTA4IDEwOCIgZmlsbD0ibm9uZSI+CjxyZWN0IHdpZHRoPSIxMDgiIGhlaWdodD0iMTA4IiByeD0iMjYiIGZpbGw9IiNBQjlGRjIiLz4KPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik00Ni41MjY3IDY5LjkyMjlDNDIuMDA1NCA3Ni44NTA5IDM0LjQyOTIgODUuNjE4MiAyNC4zNDggODUuNjE4MkMxOS41ODI0IDg1LjYxODIgMTUgODMuNjU2MyAxNSA3NS4xMzQyQzE1IDUzLjQzMDUgNDQuNjMyNiAxOS44MzI3IDcyLjEyNjggMTkuODMyN0M4Ny43NjggMTkuODMyNyA5NCAzMC42ODQ2IDk0IDQzLjAwNzlDOTQgNTguODI1OCA4My43MzU1IDc2LjkxMjIgNzMuNTMyMSA3Ni45MTIyQzcwLjI5MzkgNzYuOTEyMiA2OC43MDUzIDc1LjEzNDIgNjguNzA1MyA3Mi4zMTRDNjguNzA1MyA3MS41NzgzIDY4LjgyNzUgNzAuNzgxMiA2OS4wNzE5IDY5LjkyMjlDNjUuNTg5MyA3NS44Njk5IDU4Ljg2ODUgODEuMzg3OCA1Mi41NzU0IDgxLjM4NzhDNDcuOTkzIDgxLjM4NzggNDUuNjcxMyA3OC41MDYzIDQ1LjY3MTMgNzQuNDU5OEM0NS42NzEzIDcyLjk4ODQgNDUuOTc2OCA3MS40NTU2IDQ2LjUyNjcgNjkuOTIyOVpNODMuNjc2MSA0Mi41Nzk0QzgzLjY3NjEgNDYuMTcwNCA4MS41NTc1IDQ3Ljk2NTggNzkuMTg3NSA0Ny45NjU4Qzc2Ljc4MTYgNDcuOTY1OCA3NC42OTg5IDQ2LjE3MDQgNzQuNjk4OSA0Mi41Nzk0Qzc0LjY5ODkgMzguOTg4NSA3Ni43ODE2IDM3LjE5MzEgNzkuMTg3NSAzNy4xOTMxQzgxLjU1NzUgMzcuMTkzMSA4My42NzYxIDM4Ljk4ODUgODMuNjc2MSA0Mi41Nzk0Wk03MC4yMTAzIDQyLjU3OTVDNzAuMjEwMyA0Ni4xNzA0IDY4LjA5MTYgNDcuOTY1OCA2NS43MjE2IDQ3Ljk2NThDNjMuMzE1NyA0Ny45NjU4IDYxLjIzMyA0Ni4xNzA0IDYxLjIzMyA0Mi41Nzk1QzYxLjIzMyAzOC45ODg1IDYzLjMxNTcgMzcuMTkzMSA2NS43MjE2IDM3LjE5MzFDNjguMDkxNiAzNy4xOTMxIDcwLjIxMDMgMzguOTg4NSA3MC4yMTAzIDQyLjU3OTVaIiBmaWxsPSIjRkZGREY4Ii8+Cjwvc3ZnPg==',
  backpack: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4IiB2aWV3Qm94PSIwIDAgMTI4IDEyOCIgZmlsbD0ibm9uZSI+PHJlY3Qgd2lkdGg9IjEyOCIgaGVpZ2h0PSIxMjgiIHJ4PSIyNiIgZmlsbD0iIzE5MTkxOSIvPjxwYXRoIGQ9Ik00NC44IDQ0LjhWMzguNGMwLTEwLjYgOC42LTE5LjIgMTkuMi0xOS4yczE5LjIgOC42IDE5LjIgMTkuMnY2LjQiIHN0cm9rZT0iI0UzM0UzRiIgc3Ryb2tlLXdpZHRoPSI2IiBzdHJva2UtbGluZWNhcD0icm91bmQiIGZpbGw9Im5vbmUiLz48cmVjdCB4PSIzMiIgeT0iNTEuMiIgd2lkdGg9IjY0IiBoZWlnaHQ9IjQ0LjgiIHJ4PSIxMiIgZmlsbD0iI0UzM0UzRiIvPjxyZWN0IHg9IjQ4IiB5PSI2NyIgd2lkdGg9IjMyIiBoZWlnaHQ9IjgiIHJ4PSI0IiBmaWxsPSIjMTkxOTE5Ii8+PC9zdmc+',
  solflare: 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c3ZnIGlkPSJTIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MCA1MCI+PGRlZnM+PHN0eWxlPi5jbHMtMXtmaWxsOiMwMjA1MGE7c3Ryb2tlOiNmZmVmNDY7c3Ryb2tlLW1pdGVybGltaXQ6MTA7c3Ryb2tlLXdpZHRoOi41cHg7fS5jbHMtMntmaWxsOiNmZmVmNDY7fTwvc3R5bGU+PC9kZWZzPjxyZWN0IGNsYXNzPSJjbHMtMiIgeD0iMCIgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiByeD0iMTIiIHJ5PSIxMiIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTI0LjIzLDI2LjQybDIuNDYtMi4zOCw0LjU5LDEuNWMzLjAxLDEsNC41MSwyLjg0LDQuNTEsNS40MywwLDEuOTYtLjc1LDMuMjYtMi4yNSw0LjkzbC0uNDYuNS4xNy0xLjE3Yy42Ny00LjI2LS41OC02LjA5LTQuNzItNy40M2wtNC4zLTEuMzhoMFpNMTguMDUsMTEuODVsMTIuNTIsNC4xNy0yLjcxLDIuNTktNi41MS0yLjE3Yy0yLjI1LS43NS0zLjAxLTEuOTYtMy4zLTQuNTF2LS4wOGgwWk0xNy4zLDMzLjA2bDIuODQtMi43MSw1LjM0LDEuNzVjMi44LjkyLDMuNzYsMi4xMywzLjQ2LDUuMThsLTExLjY1LTQuMjJoMFpNMTMuNzEsMjAuOTVjMC0uNzkuNDItMS41NCwxLjEzLTIuMTcuNzUsMS4wOSwyLjA1LDIuMDUsNC4wOSwyLjcxbDQuNDIsMS40Ni0yLjQ2LDIuMzgtNC4zNC0xLjQyYy0yLS42Ny0yLjg0LTEuNjctMi44NC0yLjk2TTI2LjgyLDQyLjg3YzkuMTgtNi4wOSwxNC4xMS0xMC4yMywxNC4xMS0xNS4zMiwwLTMuMzgtMi01LjI2LTYuNDMtNi43MmwtMy4zNC0xLjEzLDkuMTQtOC43Ny0xLjg0LTEuOTYtMi43MSwyLjM4LTEyLjgxLTQuMjJjLTMuOTcsMS4yOS04Ljk3LDUuMDktOC45Nyw4Ljg5LDAsLjQyLjA0LjgzLjE3LDEuMjktMy4zLDEuODgtNC42MywzLjYzLTQuNjMsNS44LDAsMi4wNSwxLjA5LDQuMDksNC41NSw1LjIybDIuNzUuOTItOS41Miw5LjE0LDEuODQsMS45NiwyLjk2LTIuNzEsMTQuNzMsNS4yMmgwWiIvPjwvc3ZnPg==',
};

// ─── Wallet Detection ───

function getWalletProviders() {
  const providers = [];
  if (window.phantom?.solana?.isPhantom) {
    const p = window.phantom.solana;
    providers.push({ name: 'Phantom', provider: p, icon: p.icon || WALLET_ICONS.phantom });
  }
  if (window.backpack?.isBackpack) {
    const p = window.backpack;
    providers.push({ name: 'Backpack', provider: p, icon: p.icon || WALLET_ICONS.backpack });
  }
  if (window.solflare?.isSolflare) {
    const p = window.solflare;
    providers.push({ name: 'Solflare', provider: p, icon: p.icon || WALLET_ICONS.solflare });
  }
  return providers;
}

// ─── API Helpers ───

async function api(path, opts = {}) {
  const headers = { 'Content-Type': 'application/json', ...opts.headers };
  if (STATE.apiKeyFull) headers['Authorization'] = `Bearer ${STATE.apiKeyFull}`;
  let res;
  try {
    res = await fetch(`${API_BASE}${path}`, { ...opts, headers });
  } catch {
    throw new Error('API unreachable. The proxy server may not be deployed yet.');
  }
  const text = await res.text();
  let data;
  try { data = JSON.parse(text); } catch { throw new Error(`Server error: ${res.status}`); }
  if (!res.ok) throw { status: res.status, message: data.message || data.error, ...data };
  return data;
}

function maskKey(key) {
  if (!key) return 'No key';
  return key.slice(0, 18) + '...' + key.slice(-4);
}

function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ─── Markdown Renderer ───

function renderMarkdown(text) {
  if (!text) return '';
  let html = escapeHtml(text);

  // Code blocks: ```lang\ncode\n```
  html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) => {
    const id = 'cb_' + Math.random().toString(36).slice(2, 8);
    return `<pre><span class="code-lang">${lang || 'code'}</span><button class="code-copy" data-copy-id="${id}">copy</button><code id="${id}">${code.trimEnd()}</code></pre>`;
  });

  // Inline code
  html = html.replace(/`([^`\n]+)`/g, '<code>$1</code>');

  // Headings
  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

  // Bold + Italic
  html = html.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

  // Blockquotes
  html = html.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');

  // Unordered lists
  html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
  html = html.replace(/(<li>[\s\S]*?<\/li>)/g, '<ul>$1</ul>');
  html = html.replace(/<\/ul>\s*<ul>/g, '');

  // Ordered lists
  html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');

  // Line breaks (but not inside pre/code blocks)
  html = html.replace(/\n/g, '<br>');
  // Clean up extra <br> inside tags
  html = html.replace(/<br><\/?(ul|ol|li|pre|h[1-3]|blockquote)/g, '</$1');

  return html;
}

// ─── Session Persistence ───

function saveSession() {
  if (!STATE.connected) return;
  localStorage.setItem(STORAGE_KEY, JSON.stringify({
    wallet: STATE.wallet,
    apiKey: STATE.apiKeyFull,
    tier: STATE.tier,
    balance: STATE.balance,
    models: STATE.models,
  }));
}

function loadSession() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return false;
    const saved = JSON.parse(raw);
    if (!saved.wallet || !saved.apiKey) return false;
    STATE.wallet = saved.wallet;
    STATE.apiKeyFull = saved.apiKey;
    STATE.apiKey = maskKey(saved.apiKey);
    STATE.tier = saved.tier;
    STATE.balance = saved.balance;
    STATE.models = saved.models || [];
    STATE.connected = true;
    return true;
  } catch { return false; }
}

function clearSession() {
  localStorage.removeItem(STORAGE_KEY);
  if (statusPollInterval) clearInterval(statusPollInterval);
  Object.assign(STATE, {
    connected: false, connecting: false, wallet: null, walletProvider: null,
    apiKey: null, apiKeyFull: null, tier: null, balance: 0,
    usage: { today: 0, limit: 0, remaining: 0 }, models: [], keyVisible: false, error: null,
  });
}

// ─── Chat Persistence ───

function saveChatHistory() {
  const toSave = CHAT.conversations.slice(-30).map(c => ({
    id: c.id, title: c.title,
    messages: c.messages.slice(-100).map(m => {
      const saved = { role: m.role, content: m.content };
      if (m.model) saved.model = m.model;
      if (m.sources) saved.sources = m.sources;
      // Strip base64 image data from localStorage (too large)
      if (m.images) saved.hasImages = true;
      return saved;
    }),
  }));
  try {
    localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify({ conversations: toSave, activeId: CHAT.activeId }));
  } catch { /* storage full */ }
}

function loadChatHistory() {
  try {
    const raw = localStorage.getItem(CHAT_STORAGE_KEY);
    if (!raw) return;
    const data = JSON.parse(raw);
    CHAT.conversations = data.conversations || [];
    CHAT.activeId = data.activeId;
  } catch {}
}

function getActiveConversation() {
  if (!CHAT.activeId) {
    newConversation(false);
  }
  return CHAT.conversations.find(c => c.id === CHAT.activeId);
}

function newConversation(doRender = true) {
  const conv = {
    id: 'conv_' + Date.now(),
    title: 'New chat',
    messages: [],
  };
  CHAT.conversations.push(conv);
  CHAT.activeId = conv.id;
  if (doRender) render();
}

// ─── Wallet Connect ───

async function connectWallet(providerObj) {
  STATE.connecting = true;
  STATE.error = null;
  render();

  try {
    const provider = providerObj || getWalletProviders()[0]?.provider;
    if (!provider) throw new Error('No Solana wallet found. Install Phantom, Backpack, or Solflare.');

    const resp = await provider.connect();
    const publicKey = resp.publicKey.toString();
    const message = `INFINITE Protocol: Verify wallet ownership\n\nWallet: ${publicKey}\nTimestamp: ${Date.now()}`;
    const encoded = new TextEncoder().encode(message);
    const signatureBytes = await provider.signMessage(encoded, 'utf8');
    const sig = btoa(String.fromCharCode(...new Uint8Array(signatureBytes.signature || signatureBytes)));

    const data = await api('/auth/register', {
      method: 'POST',
      body: JSON.stringify({ wallet: publicKey, signature: sig, message }),
    });

    STATE.connected = true;
    STATE.wallet = publicKey;
    STATE.walletProvider = provider;
    STATE.apiKeyFull = data.apiKey;
    STATE.apiKey = maskKey(data.apiKey);
    STATE.tier = data.tier;
    STATE.balance = data.balance;
    STATE.models = data.models || [];
    STATE.usage = { today: 0, limit: data.dailyLimit, remaining: data.dailyLimit };

    // Default chat model to first available
    if (STATE.models.length && !CHAT.selectedModel) {
      CHAT.selectedModel = STATE.models[0];
    }

    saveSession();
    startStatusPolling();
  } catch (err) {
    STATE.error = err.message || 'Connection failed';
  } finally {
    STATE.connecting = false;
    render();
  }
}

// ─── Status Polling ───

async function fetchStatus() {
  if (!STATE.apiKeyFull) return;
  try {
    const data = await api('/auth/status');
    STATE.tier = data.tier;
    STATE.balance = data.balance;
    STATE.usage = data.usage;
    STATE.models = data.models || STATE.models;
    if (STATE.models.length && !CHAT.selectedModel) CHAT.selectedModel = STATE.models[0];
    saveSession();
    // Only full re-render if NOT in interactive tabs
    if (!['chat', 'images', 'video', 'trading'].includes(STATE.activeTab)) render();
    else updateSidebarFooter();
  } catch (err) {
    if (err.status === 401) { clearSession(); render(); }
  }
}

async function fetchTreasury() {
  try { STATE.treasury = await api('/treasury'); } catch {}
}

async function fetchProviders() {
  try { STATE.providers = await api('/providers'); } catch {}
}

async function fetchOAuthStatus() {
  try { STATE.connections = await api('/oauth/status'); } catch {}
}

function startStatusPolling() {
  fetchStatus();
  fetchTreasury();
  fetchProviders();
  fetchOAuthStatus();
  if (statusPollInterval) clearInterval(statusPollInterval);
  statusPollInterval = setInterval(() => { fetchStatus(); fetchTreasury(); }, 60_000);
}

function updateSidebarFooter() {
  const el = document.getElementById('sidebarFooterInfo');
  if (el) el.textContent = `${STATE.tier || '—'} Tier — ${STATE.balance.toLocaleString()} $INF`;
}

// ─── Chat Logic ───

async function sendChatMessage() {
  const input = document.getElementById('chatInput');
  if (!input) return;
  const text = input.value.trim();
  if (!text || CHAT.isGenerating) return;

  input.value = '';
  input.style.height = 'auto';

  const conv = getActiveConversation();
  const sentImages = CHAT.pendingImages.length > 0 ? [...CHAT.pendingImages] : null;
  conv.messages.push({ role: 'user', content: text, images: sentImages });

  // Update title from first message
  if (conv.messages.filter(m => m.role === 'user').length === 1) {
    conv.title = text.slice(0, 50) + (text.length > 50 ? '...' : '');
  }

  appendMessageToDOM({ role: 'user', content: text, images: sentImages });
  showTypingIndicator();
  CHAT.isGenerating = true;
  updateSendButton();

  const model = CHAT.selectedModel || STATE.models[0] || 'claude-sonnet-4-5-20250929';
  const tools = CHAT.enabledTools.length > 0 ? [...CHAT.enabledTools] : undefined;
  const images = sentImages || undefined;

  // Clear pending images after capturing
  CHAT.pendingImages = [];
  renderImagePreview();

  try {
    CHAT.abortController = new AbortController();

    const response = await fetch(`${API_BASE}/v1/chat/stream`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${STATE.apiKeyFull}`,
      },
      body: JSON.stringify({
        model,
        messages: conv.messages.map(m => ({ role: m.role, content: m.content })),
        tools,
        images,
      }),
      signal: CHAT.abortController.signal,
    });

    if (!response.ok) {
      const err = await response.json().catch(() => ({ message: `HTTP ${response.status}` }));
      throw new Error(err.message || 'Request failed');
    }

    removeTypingIndicator();

    const msgEl = appendMessageToDOM({ role: 'assistant', content: '', model });
    const contentEl = msgEl.querySelector('.chat-msg-content');
    const bodyEl = msgEl.querySelector('.chat-msg-body');

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let fullText = '';
    let buffer = '';
    let collectedSources = [];
    let collectedToolResults = [];

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop() || '';

      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        const jsonStr = line.slice(6).trim();
        if (!jsonStr) continue;
        try {
          const data = JSON.parse(jsonStr);
          if (data.type === 'text') {
            fullText += data.content;
            contentEl.innerHTML = renderMarkdown(fullText);
            scrollChat();
          } else if (data.type === 'tool_start') {
            showToolIndicator(bodyEl, data.tool, data.query);
          } else if (data.type === 'tool_result') {
            removeToolIndicator(bodyEl);
            if (data.tool === 'web_search' && data.sources && data.sources.length > 0) {
              collectedSources = collectedSources.concat(data.sources);
              showSearchSources(bodyEl, collectedSources);
            } else if (data.tool && data.data) {
              collectedToolResults.push({ tool: data.tool, data: data.data });
              showToolResultCard(bodyEl, data.tool, data.data);
            }
          } else if (data.type === 'error') {
            throw new Error(data.message);
          }
        } catch (e) {
          if (e.message && !e.message.includes('JSON')) throw e;
        }
      }
    }

    removeToolIndicator(bodyEl);
    conv.messages.push({
      role: 'assistant', content: fullText, model,
      sources: collectedSources.length > 0 ? collectedSources : undefined,
      toolResults: collectedToolResults.length > 0 ? collectedToolResults : undefined,
    });
    saveChatHistory();
    bindCodeCopyButtons();

  } catch (err) {
    removeTypingIndicator();
    if (err.name !== 'AbortError') {
      appendMessageToDOM({ role: 'assistant', content: `Error: ${err.message}`, isError: true });
    }
  } finally {
    CHAT.isGenerating = false;
    CHAT.abortController = null;
    updateSendButton();
  }
}

function appendMessageToDOM(msg) {
  const container = document.getElementById('chatMessages');
  if (!container) return null;

  // Remove empty state if present
  const empty = container.querySelector('.chat-empty');
  if (empty) empty.remove();

  const imagesHtml = msg.images ? `<div class="chat-msg-images">${msg.images.map(img =>
    `<img src="data:${img.mimeType};base64,${img.data}" alt="uploaded">`
  ).join('')}</div>` : '';

  const el = document.createElement('div');
  el.className = `chat-message ${msg.role}`;
  el.innerHTML = `
    <div class="chat-msg-avatar">${msg.role === 'user' ? 'You' : 'AI'}</div>
    <div class="chat-msg-body">
      <div class="chat-msg-name">${msg.role === 'user' ? 'You' : (msg.model || 'AI')}</div>
      ${imagesHtml}
      <div class="chat-msg-content${msg.isError ? ' error' : ''}">${
        msg.role === 'user' ? escapeHtml(msg.content) : (msg.content ? renderMarkdown(msg.content) : '')
      }</div>
    </div>
  `;
  container.appendChild(el);
  scrollChat();
  return el;
}

function showTypingIndicator() {
  const container = document.getElementById('chatMessages');
  if (!container) return;
  const el = document.createElement('div');
  el.className = 'chat-message assistant';
  el.id = 'typingIndicator';
  el.innerHTML = `
    <div class="chat-msg-avatar">AI</div>
    <div class="chat-msg-body">
      <div class="chat-typing">
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
      </div>
    </div>
  `;
  container.appendChild(el);
  scrollChat();
}

function removeTypingIndicator() {
  document.getElementById('typingIndicator')?.remove();
}

function scrollChat() {
  const el = document.getElementById('chatMessages');
  if (el) el.scrollTop = el.scrollHeight;
}

function updateSendButton() {
  const btn = document.getElementById('chatSendBtn');
  if (btn) {
    btn.disabled = CHAT.isGenerating;
    btn.textContent = CHAT.isGenerating ? '...' : '\u2192';
  }
}

function bindCodeCopyButtons() {
  document.querySelectorAll('.code-copy[data-copy-id]').forEach(btn => {
    btn.onclick = () => {
      const code = document.getElementById(btn.dataset.copyId);
      if (code) copyText(code.textContent);
    };
  });
}

// ─── Tool Indicators ───

const TOOL_LABELS = {
  web_search: (q) => `Searching the web${q ? ` for "${escapeHtml(q)}"` : ''}...`,
  url_reader: (q) => `Reading URL${q ? `: ${escapeHtml(q.slice(0, 60))}` : ''}...`,
  code_runner: () => 'Running code...',
  github_lookup: (q) => `Looking up GitHub${q ? `: ${escapeHtml(q)}` : ''}...`,
  google_lookup: (q) => `Searching Google Drive${q ? `: ${escapeHtml(q)}` : ''}...`,
  notion_lookup: (q) => `Searching Notion${q ? `: ${escapeHtml(q)}` : ''}...`,
};

function showToolIndicator(bodyEl, tool, query) {
  if (!bodyEl) return;
  removeToolIndicator(bodyEl);
  const el = document.createElement('div');
  el.className = 'tool-indicator';
  const labelFn = TOOL_LABELS[tool] || TOOL_LABELS.web_search;
  el.innerHTML = `<div class="tool-spinner"></div><span>${labelFn(query)}</span>`;
  const contentEl = bodyEl.querySelector('.chat-msg-content');
  if (contentEl) bodyEl.insertBefore(el, contentEl);
  else bodyEl.appendChild(el);
  scrollChat();
}

function removeToolIndicator(bodyEl) {
  if (!bodyEl) return;
  bodyEl.querySelector('.tool-indicator')?.remove();
}

function showSearchSources(bodyEl, sources) {
  if (!bodyEl || !sources || sources.length === 0) return;
  bodyEl.querySelector('.search-sources')?.remove();
  const el = document.createElement('div');
  el.className = 'search-sources';
  el.innerHTML = sources.slice(0, 6).map(s => {
    let label = s.title;
    if (!label) try { label = new URL(s.url).hostname; } catch { label = s.url; }
    return `<a class="search-source-chip" href="${escapeHtml(s.url)}" target="_blank" rel="noopener">${escapeHtml(label)}</a>`;
  }).join('');
  const contentEl = bodyEl.querySelector('.chat-msg-content');
  if (contentEl) bodyEl.insertBefore(el, contentEl);
  else bodyEl.appendChild(el);
  scrollChat();
}

function renderToolResultCardHtml(tool, data) {
  if (!data) return '';
  if (data.error) {
    return `<div class="tool-result-card"><div class="trc-header"><span class="trc-icon"></span>${escapeHtml(tool)}</div><div class="trc-error">${escapeHtml(data.error)}</div></div>`;
  }
  if (tool === 'url_reader') {
    const title = data.title || 'Untitled';
    const preview = (data.content || '').slice(0, 150).replace(/\n/g, ' ');
    let urlDisplay = '';
    if (data.url) try { urlDisplay = new URL(data.url).hostname; } catch { urlDisplay = data.url; }
    return `<div class="tool-result-card"><div class="trc-header"><span class="trc-icon"></span>URL READER</div><div class="trc-title">${data.url ? `<a href="${escapeHtml(data.url)}" target="_blank" rel="noopener">${escapeHtml(title)}</a>` : escapeHtml(title)}</div><div class="trc-body">${escapeHtml(preview)}${data.truncated ? '...' : ''}</div><div class="trc-meta"><span>${escapeHtml(urlDisplay)}</span></div></div>`;
  }
  if (tool === 'code_runner') {
    const displayText = data.output || data.returnValue || '(no output)';
    return `<div class="tool-result-card"><div class="trc-header"><span class="trc-icon"></span>CODE RUNNER</div><div class="trc-body code-output">${escapeHtml(displayText.slice(0, 500))}</div><div class="trc-meta">${data.executionTimeMs != null ? `<span>${data.executionTimeMs}ms</span>` : ''}</div></div>`;
  }
  if (tool === 'github_lookup') {
    if (data.name && data.stars !== undefined) {
      return `<div class="tool-result-card"><div class="trc-header"><span class="trc-icon"></span>GITHUB</div><div class="trc-title"><a href="${escapeHtml(data.url || '')}" target="_blank" rel="noopener">${escapeHtml(data.name)}</a></div><div class="trc-body">${escapeHtml(data.description || '')}</div><div class="trc-stats"><span class="trc-stat">Stars <span>${(data.stars || 0).toLocaleString()}</span></span><span class="trc-stat">Forks <span>${(data.forks || 0).toLocaleString()}</span></span></div></div>`;
    }
    if (data.type === 'file') {
      return `<div class="tool-result-card"><div class="trc-header"><span class="trc-icon"></span>GITHUB FILE</div><div class="trc-title">${escapeHtml(data.path || '')}</div><div class="trc-body code-output">${escapeHtml((data.content || '').slice(0, 300))}</div></div>`;
    }
    if (Array.isArray(data)) {
      return `<div class="tool-result-card"><div class="trc-header"><span class="trc-icon"></span>GITHUB ISSUES</div><div class="trc-body">${data.slice(0, 5).map(i => `#${i.number} ${escapeHtml(i.title)}`).join('<br>')}</div></div>`;
    }
  }
  if (tool === 'google_lookup') {
    if (data.files) {
      return `<div class="tool-result-card"><div class="trc-header"><span class="trc-icon"></span>GOOGLE DRIVE</div><div class="trc-body">${data.files.slice(0, 5).map(f => `<a href="${escapeHtml(f.url || '')}" target="_blank" rel="noopener">${escapeHtml(f.name)}</a>`).join('<br>')}</div><div class="trc-meta"><span>${data.files.length} files found</span></div></div>`;
    }
    if (data.title) {
      return `<div class="tool-result-card"><div class="trc-header"><span class="trc-icon"></span>GOOGLE DOC</div><div class="trc-title">${escapeHtml(data.title)}</div><div class="trc-body">${escapeHtml((data.content || '').slice(0, 200))}</div></div>`;
    }
  }
  if (tool === 'notion_lookup') {
    if (data.results) {
      return `<div class="tool-result-card"><div class="trc-header"><span class="trc-icon"></span>NOTION</div><div class="trc-body">${data.results.slice(0, 5).map(r => `<a href="${escapeHtml(r.url || '')}" target="_blank" rel="noopener">${escapeHtml(r.title)}</a> <span class="dim">${r.type}</span>`).join('<br>')}</div></div>`;
    }
    if (data.title) {
      return `<div class="tool-result-card"><div class="trc-header"><span class="trc-icon"></span>NOTION PAGE</div><div class="trc-title">${escapeHtml(data.title)}</div><div class="trc-body">${escapeHtml((data.content || '').slice(0, 200))}</div></div>`;
    }
    if (data.entries) {
      return `<div class="tool-result-card"><div class="trc-header"><span class="trc-icon"></span>NOTION DATABASE</div><div class="trc-body">${data.entries.slice(0, 5).map(e => escapeHtml(JSON.stringify(e.properties).slice(0, 80))).join('<br>')}</div><div class="trc-meta"><span>${data.total} entries</span></div></div>`;
    }
  }
  return `<div class="tool-result-card"><div class="trc-header"><span class="trc-icon"></span>${escapeHtml(tool)}</div><div class="trc-body">${escapeHtml(JSON.stringify(data).slice(0, 200))}</div></div>`;
}

function showToolResultCard(bodyEl, tool, data) {
  if (!bodyEl || !data) return;
  const el = document.createElement('div');
  el.className = 'tool-result-card';

  if (data.error) {
    el.innerHTML = `
      <div class="trc-header"><span class="trc-icon"></span>${escapeHtml(tool)}</div>
      <div class="trc-error">${escapeHtml(data.error)}</div>
    `;
  } else if (tool === 'url_reader') {
    const title = data.title || 'Untitled';
    const preview = (data.content || '').slice(0, 150).replace(/\n/g, ' ');
    const urlDisplay = data.url ? (() => { try { return new URL(data.url).hostname; } catch { return data.url; } })() : '';
    el.innerHTML = `
      <div class="trc-header"><span class="trc-icon"></span>URL READER</div>
      <div class="trc-title">${data.url ? `<a href="${escapeHtml(data.url)}" target="_blank" rel="noopener">${escapeHtml(title)}</a>` : escapeHtml(title)}</div>
      <div class="trc-body">${escapeHtml(preview)}${data.truncated ? '...' : ''}</div>
      <div class="trc-meta"><span>${escapeHtml(urlDisplay)}</span>${data.contentLength ? `<span>${(data.contentLength / 1024).toFixed(1)}KB</span>` : ''}</div>
    `;
  } else if (tool === 'code_runner') {
    const output = data.output || '';
    const retVal = data.returnValue || '';
    const displayText = output || retVal || '(no output)';
    el.innerHTML = `
      <div class="trc-header"><span class="trc-icon"></span>CODE RUNNER</div>
      <div class="trc-body code-output">${escapeHtml(displayText.slice(0, 500))}</div>
      <div class="trc-meta">${data.executionTimeMs != null ? `<span>${data.executionTimeMs}ms</span>` : ''}</div>
    `;
  } else if (tool === 'github_lookup') {
    if (data.name && data.stars !== undefined) {
      // repo_info
      el.innerHTML = `
        <div class="trc-header"><span class="trc-icon"></span>GITHUB</div>
        <div class="trc-title"><a href="${escapeHtml(data.url || '')}" target="_blank" rel="noopener">${escapeHtml(data.name)}</a></div>
        <div class="trc-body">${escapeHtml(data.description || 'No description')}</div>
        <div class="trc-stats">
          <span class="trc-stat">Stars <span>${(data.stars || 0).toLocaleString()}</span></span>
          <span class="trc-stat">Forks <span>${(data.forks || 0).toLocaleString()}</span></span>
          <span class="trc-stat">Lang <span>${escapeHtml(data.language || '—')}</span></span>
        </div>
      `;
    } else if (data.type === 'file') {
      el.innerHTML = `
        <div class="trc-header"><span class="trc-icon"></span>GITHUB FILE</div>
        <div class="trc-title">${escapeHtml(data.path || '')}</div>
        <div class="trc-body code-output">${escapeHtml((data.content || '').slice(0, 500))}</div>
        ${data.size ? `<div class="trc-meta"><span>${(data.size / 1024).toFixed(1)}KB</span></div>` : ''}
      `;
    } else if (data.type === 'directory') {
      el.innerHTML = `
        <div class="trc-header"><span class="trc-icon"></span>GITHUB DIR</div>
        <div class="trc-title">${escapeHtml(data.path || '/')}</div>
        <div class="trc-body">${(data.files || []).slice(0, 15).map(f => escapeHtml(f.name)).join(', ')}</div>
      `;
    } else if (data.totalCount !== undefined) {
      // search_code
      el.innerHTML = `
        <div class="trc-header"><span class="trc-icon"></span>GITHUB SEARCH</div>
        <div class="trc-body">${data.totalCount} results found</div>
        <div class="trc-meta">${(data.items || []).slice(0, 5).map(i => escapeHtml(i.path)).join(', ')}</div>
      `;
    } else if (Array.isArray(data)) {
      // list_issues
      el.innerHTML = `
        <div class="trc-header"><span class="trc-icon"></span>GITHUB ISSUES</div>
        <div class="trc-body">${data.slice(0, 5).map(i => `#${i.number} ${escapeHtml(i.title)}`).join('<br>')}</div>
      `;
    } else {
      el.innerHTML = `
        <div class="trc-header"><span class="trc-icon"></span>GITHUB</div>
        <div class="trc-body">${escapeHtml(JSON.stringify(data).slice(0, 200))}</div>
      `;
    }
  } else if (tool === 'google_lookup') {
    if (data.files) {
      el.innerHTML = `
        <div class="trc-header"><span class="trc-icon"></span>GOOGLE DRIVE</div>
        <div class="trc-body">${data.files.slice(0, 5).map(f => `<a href="${escapeHtml(f.url || '')}" target="_blank" rel="noopener">${escapeHtml(f.name)}</a>`).join('<br>')}</div>
        <div class="trc-meta"><span>${data.files.length} files found</span></div>
      `;
    } else if (data.title) {
      el.innerHTML = `
        <div class="trc-header"><span class="trc-icon"></span>GOOGLE DOC</div>
        <div class="trc-title">${escapeHtml(data.title)}</div>
        <div class="trc-body">${escapeHtml((data.content || '').slice(0, 300))}</div>
      `;
    } else {
      el.innerHTML = `
        <div class="trc-header"><span class="trc-icon"></span>GOOGLE</div>
        <div class="trc-body">${escapeHtml(JSON.stringify(data).slice(0, 200))}</div>
      `;
    }
  } else if (tool === 'notion_lookup') {
    if (data.results) {
      el.innerHTML = `
        <div class="trc-header"><span class="trc-icon"></span>NOTION</div>
        <div class="trc-body">${data.results.slice(0, 5).map(r => `<a href="${escapeHtml(r.url || '')}" target="_blank" rel="noopener">${escapeHtml(r.title)}</a>`).join('<br>')}</div>
      `;
    } else if (data.title) {
      el.innerHTML = `
        <div class="trc-header"><span class="trc-icon"></span>NOTION PAGE</div>
        <div class="trc-title">${escapeHtml(data.title)}</div>
        <div class="trc-body">${escapeHtml((data.content || '').slice(0, 300))}</div>
      `;
    } else if (data.entries) {
      el.innerHTML = `
        <div class="trc-header"><span class="trc-icon"></span>NOTION DATABASE</div>
        <div class="trc-body">${data.entries.slice(0, 5).map(e => escapeHtml(JSON.stringify(e.properties).slice(0, 80))).join('<br>')}</div>
        <div class="trc-meta"><span>${data.total} entries</span></div>
      `;
    } else {
      el.innerHTML = `
        <div class="trc-header"><span class="trc-icon"></span>NOTION</div>
        <div class="trc-body">${escapeHtml(JSON.stringify(data).slice(0, 200))}</div>
      `;
    }
  }

  const contentEl = bodyEl.querySelector('.chat-msg-content');
  if (contentEl) bodyEl.insertBefore(el, contentEl);
  else bodyEl.appendChild(el);
  scrollChat();
}

// ─── Image Upload ───

function handleImageUpload(files) {
  if (!files || files.length === 0) return;
  const maxFiles = 4;
  const maxSize = 5 * 1024 * 1024; // 5MB

  for (const file of Array.from(files).slice(0, maxFiles - CHAT.pendingImages.length)) {
    if (!file.type.startsWith('image/')) continue;
    if (file.size > maxSize) { showToast('Image too large (max 5MB)', true); continue; }

    const reader = new FileReader();
    reader.onload = (e) => {
      const base64 = e.target.result.split(',')[1];
      CHAT.pendingImages.push({ data: base64, mimeType: file.type, name: file.name });
      renderImagePreview();
    };
    reader.readAsDataURL(file);
  }
}

function removePendingImage(index) {
  CHAT.pendingImages.splice(index, 1);
  renderImagePreview();
}

function renderImagePreview() {
  const existing = document.getElementById('chatImagePreview');
  if (CHAT.pendingImages.length === 0) {
    if (existing) existing.remove();
    return;
  }

  const html = CHAT.pendingImages.map((img, i) => `
    <div class="chat-image-thumb">
      <img src="data:${img.mimeType};base64,${img.data}" alt="upload">
      <button class="remove-img" onclick="removePendingImage(${i})">x</button>
    </div>
  `).join('');

  if (existing) {
    existing.innerHTML = html;
  } else {
    const inputArea = document.querySelector('.chat-input-area');
    if (inputArea) {
      const preview = document.createElement('div');
      preview.className = 'chat-image-preview';
      preview.id = 'chatImagePreview';
      preview.innerHTML = html;
      inputArea.parentNode.insertBefore(preview, inputArea);
    }
  }
}

// ─── Image Generation ───

async function generateImage() {
  const input = document.getElementById('imagePrompt');
  if (!input) return;
  const prompt = input.value.trim();
  if (!prompt || IMAGES.isGenerating) return;

  IMAGES.isGenerating = true;
  renderImageState();

  try {
    const data = await api('/v1/image', {
      method: 'POST',
      body: JSON.stringify({ prompt }),
    });

    if (data.images?.length > 0) {
      for (const img of data.images) {
        IMAGES.gallery.unshift({
          data: img.data,
          mimeType: img.mimeType,
          prompt,
          text: data.text,
          id: data.id,
        });
      }
    }
    input.value = '';
  } catch (err) {
    showToast(err.message || 'Image generation failed', true);
  } finally {
    IMAGES.isGenerating = false;
    renderImageState();
  }
}

function renderImageState() {
  const gallery = document.getElementById('imageGallery');
  const btn = document.getElementById('imageGenBtn');
  if (btn) {
    btn.disabled = IMAGES.isGenerating;
    btn.textContent = IMAGES.isGenerating ? 'GENERATING...' : 'CREATE';
  }
  if (gallery) {
    gallery.innerHTML = IMAGES.isGenerating
      ? `<div class="image-loading"><div class="image-spinner"></div><span style="font-family:var(--font-mono);font-size:11px;">Generating image...</span></div>`
      : IMAGES.gallery.map(img => `
        <div class="image-card">
          <img src="data:${img.mimeType};base64,${img.data}" alt="${escapeHtml(img.prompt)}" loading="lazy">
          <div class="image-card-footer">
            <div class="image-card-prompt">${escapeHtml(img.prompt)}</div>
            <button class="btn-sm" onclick="downloadImage('${img.data}','${img.mimeType}')">Save</button>
          </div>
        </div>
      `).join('') || '<div style="color:var(--text-muted);font-family:var(--font-mono);font-size:12px;padding:40px;text-align:center;">No images yet. Describe what you want to create.</div>';
  }
}

function downloadImage(base64, mimeType) {
  const link = document.createElement('a');
  link.href = `data:${mimeType};base64,${base64}`;
  link.download = `infinite-${Date.now()}.png`;
  link.click();
}

// ─── Actions ───

async function rotateKey() {
  if (!confirm('Rotate your API key? The old key will stop working immediately.')) return;
  try {
    const data = await api('/auth/rotate', { method: 'POST' });
    STATE.apiKeyFull = data.apiKey;
    STATE.apiKey = maskKey(data.apiKey);
    STATE.tier = data.tier;
    STATE.keyVisible = false;
    saveSession();
    showToast('Key rotated');
  } catch (err) {
    showToast(err.message || 'Rotate failed', true);
  }
  render();
}

async function revokeKey() {
  if (!confirm('Revoke your API key? All active sessions will be terminated.')) return;
  try { await api('/auth/revoke', { method: 'POST' }); showToast('Key revoked'); } catch {}
  clearSession();
  render();
}

function disconnectWallet() {
  if (STATE.walletProvider?.disconnect) STATE.walletProvider.disconnect();
  clearSession();
  render();
}

function toggleKeyVisibility() {
  STATE.keyVisible = !STATE.keyVisible;
  const el = document.getElementById('apiKeyDisplay');
  if (el) el.textContent = STATE.keyVisible ? STATE.apiKeyFull : STATE.apiKey;
}

function setTab(tab) {
  if (STATE.activeTab === 'trading' && tab !== 'trading') stopBotPolling();
  STATE.activeTab = tab;
  render();
}

function copyText(text) {
  navigator.clipboard?.writeText(text).then(() => showToast('Copied'));
}

function showToast(msg, isError = false) {
  document.getElementById('toast')?.remove();
  const el = document.createElement('div');
  el.id = 'toast';
  el.style.cssText = `position:fixed;bottom:24px;right:24px;padding:12px 20px;font-family:var(--font-mono);font-size:11px;letter-spacing:1px;z-index:10000;border:1px solid ${isError ? 'var(--red)' : 'var(--accent)'};color:${isError ? 'var(--red)' : 'var(--accent)'};background:var(--surface);`;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2500);
}

// ─── Render ───

function render() {
  const app = document.getElementById('app');
  app.className = STATE.connected ? 'app' : 'app connect-mode';
  app.innerHTML = STATE.connected ? renderDashboard() : renderConnectScreen();
  bindEvents();
}

function renderConnectScreen() {
  const providers = getWalletProviders();
  const hasWallet = providers.length > 0;
  return `
    <div class="connect-screen">
      <div class="connect-box">
        <div class="logo">INF</div>
        <h1>INFINITE Dashboard</h1>
        <p>Connect your wallet to access AI chat, image generation, trading tools, and raw API keys.</p>
        ${STATE.error ? `<div class="connect-error">${escapeHtml(STATE.error)}</div>` : ''}
        <div class="connect-wallets">
          ${STATE.connecting ? `<div class="connect-btn" style="opacity:0.6;cursor:wait;">Connecting...</div>` : hasWallet ? providers.map((p, i) => `
            <button class="connect-btn${i > 0 ? ' connect-btn-secondary' : ''}" data-provider="${i}">
              <img src="${p.icon}" alt="${p.name}" width="20" height="20" style="border-radius:4px;">
              Connect ${p.name}
            </button>
          `).join('') : `
            <button class="connect-btn" onclick="window.open('https://phantom.com/download','_blank')">Install Phantom Wallet</button>
          `}
        </div>
        <div class="connect-note">${hasWallet ? providers.map(p => p.name).join(', ') + ' detected' : 'No wallet detected'}</div>
      </div>
    </div>
  `;
}

function renderDashboard() {
  const isChat = STATE.activeTab === 'chat' || STATE.activeTab === 'trading';
  return `
    <aside class="sidebar">
      <div class="sidebar-logo">INFINITE</div>
      <nav class="sidebar-nav">
        <div class="nav-group-label">Dashboard</div>
        <div class="nav-item ${STATE.activeTab === 'overview' ? 'active' : ''}" data-tab="overview">Overview</div>
        <div class="nav-item ${STATE.activeTab === 'keys' ? 'active' : ''}" data-tab="keys">API Keys</div>
        <div class="nav-item ${STATE.activeTab === 'models' ? 'active' : ''}" data-tab="models">Models</div>
        <div class="nav-item ${STATE.activeTab === 'connections' ? 'active' : ''}" data-tab="connections">Connections</div>
        <div class="nav-group-label">Tools</div>
        <div class="nav-item ${STATE.activeTab === 'chat' ? 'active' : ''}" data-tab="chat">AI Chat</div>
        <div class="nav-item ${STATE.activeTab === 'images' ? 'active' : ''}" data-tab="images">Image Lab</div>
        <div class="nav-item ${STATE.activeTab === 'video' ? 'active' : ''}" data-tab="video">Video Lab</div>
        <div class="nav-item ${STATE.activeTab === 'trading' ? 'active' : ''}" data-tab="trading">Trade Bot</div>
        <div class="nav-item ${STATE.activeTab === 'agents' ? 'active' : ''}" data-tab="agents">Tools Hub</div>
        <div class="nav-group-label">Protocol</div>
        <div class="nav-item ${STATE.activeTab === 'future-apis' ? 'active' : ''}" data-tab="future-apis">Future APIs</div>
        <div class="nav-item ${STATE.activeTab === 'treasury' ? 'active' : ''}" data-tab="treasury">Treasury</div>
      </nav>
      <div class="sidebar-footer">
        <div class="wallet-info" id="sidebarFooterInfo">${STATE.tier || '—'} Tier — ${STATE.balance.toLocaleString()} $INF</div>
        <div class="wallet-addr" onclick="copyText('${STATE.wallet}')">
          ${STATE.wallet ? STATE.wallet.slice(0, 6) + '...' + STATE.wallet.slice(-4) : '—'}
          <span class="copy">COPY</span>
        </div>
        <div style="margin-top:8px;">
          <button class="btn-sm danger" style="width:100%;padding:8px;" onclick="disconnectWallet()">Disconnect</button>
        </div>
        <div class="sidebar-socials">
          <a href="https://x.com/infiniteonsol" target="_blank" rel="noopener" class="sidebar-social-link">X / Twitter</a>
          <a href="https://discord.gg/infinite" target="_blank" rel="noopener" class="sidebar-social-link">Discord</a>
        </div>
      </div>
    </aside>
    <main class="main${isChat ? ' chat-mode' : ''}">${renderTab()}</main>
  `;
}

function renderTab() {
  switch (STATE.activeTab) {
    case 'overview': return renderOverview();
    case 'keys': return renderKeys();
    case 'models': return renderModels();
    case 'connections': return renderConnections();
    case 'chat': return renderChat();
    case 'images': return renderImages();
    case 'video': return renderVideo();
    case 'trading': return renderTrading();
    case 'agents': return renderAgents();
    case 'future-apis': return renderFutureApis();
    case 'treasury': return renderTreasury();
    default: return renderOverview();
  }
}

// ─── Tab: Overview ───

function hasAnyChatProvider() {
  return STATE.providers.claude || STATE.providers.gemini || STATE.providers.openai;
}

function renderOverview() {
  const usagePct = STATE.usage.limit > 0 ? (STATE.usage.today / STATE.usage.limit) * 100 : 0;
  const barClass = usagePct > 90 ? 'danger' : usagePct > 70 ? 'warning' : '';
  return `
    <div class="page-header">
      <h1 class="page-title">Welcome back</h1>
      <p class="page-sub">${STATE.tier || '—'} tier — ${STATE.usage.remaining.toLocaleString()} API calls remaining today</p>
    </div>
    <div class="stats-row">
      <div class="stat-card"><div class="label">Your Tier</div><div class="value accent">${STATE.tier || '—'}</div><div class="sub">${STATE.balance.toLocaleString()} $INFINITE</div></div>
      <div class="stat-card"><div class="label">Calls Today</div><div class="value">${STATE.usage.today.toLocaleString()}</div><div class="sub">of ${STATE.usage.limit.toLocaleString()} limit</div></div>
      <div class="stat-card"><div class="label">Models Available</div><div class="value green">${STATE.models.length}</div><div class="sub">AI providers active</div></div>
      <div class="stat-card"><div class="label">Your Cost</div><div class="value accent">$0</div><div class="sub">funded by treasury</div></div>
    </div>
    <div class="section">
      <div class="section-title">Daily Usage</div>
      <div class="usage-bar-container">
        <div class="usage-header">
          <div class="usage-count">${STATE.usage.today.toLocaleString()} <span>/ ${STATE.usage.limit.toLocaleString()} calls</span></div>
          <div class="usage-count">${Math.round(usagePct)}%</div>
        </div>
        <div class="usage-bar-track"><div class="usage-bar-fill ${barClass}" style="width: ${usagePct}%"></div></div>
        <div class="usage-legend">
          <div class="usage-legend-item"><div class="usage-legend-dot" style="background: var(--accent)"></div>Used</div>
          <div class="usage-legend-item"><div class="usage-legend-dot" style="background: var(--border)"></div>Remaining</div>
          <div class="usage-legend-item" style="margin-left: auto">Resets at 00:00 UTC</div>
        </div>
      </div>
    </div>
    <div class="section">
      <div class="section-title">Quick Access</div>
      <div class="tools-grid">
        <div class="tool-card" onclick="setTab('chat')"><div class="tool-header"><span class="tool-status${hasAnyChatProvider() ? '' : ' coming'}">${hasAnyChatProvider() ? 'LIVE' : 'SOON'}</span></div><div class="tool-name">AI Chat</div><div class="tool-desc">${hasAnyChatProvider() ? 'Chat with Claude and Gemini directly. Streaming responses, markdown rendering, code highlighting.' : 'AI chat will activate after token launch. Claude, Gemini, and OpenAI models included.'}</div><div class="tool-launch">${hasAnyChatProvider() ? 'Open' : 'Preview'}</div></div>
        <div class="tool-card" onclick="setTab('images')"><div class="tool-header"><span class="tool-status${STATE.providers.gemini ? '' : ' coming'}">${STATE.providers.gemini ? 'LIVE' : 'SOON'}</span></div><div class="tool-name">Image Lab</div><div class="tool-desc">${STATE.providers.gemini ? 'Generate high-quality images with Gemini. Describe anything and get instant results.' : 'Image generation will activate after token launch. Powered by Gemini.'}</div><div class="tool-launch">${STATE.providers.gemini ? 'Open' : 'Preview'}</div></div>
        <div class="tool-card" onclick="setTab('video')"><div class="tool-header"><span class="tool-status${STATE.providers.gemini ? '' : ' coming'}">${STATE.providers.gemini ? 'LIVE' : 'SOON'}</span></div><div class="tool-name">Video Lab</div><div class="tool-desc">${STATE.providers.gemini ? 'Generate AI videos with Google Veo 2. Text to video, multiple aspect ratios.' + (isVideoTierAllowed() ? '' : ' Operator+ only.') : 'Video generation will activate after token launch. Powered by Google Veo 2.'}</div><div class="tool-launch">${STATE.providers.gemini ? 'Open' : 'Preview'}</div></div>
        <div class="tool-card" onclick="setTab('trading')"><div class="tool-header"><span class="tool-status">LIVE</span></div><div class="tool-name">Trade Bot</div><div class="tool-desc">Autonomous trading bot. Jupiter swaps, DCA, copy trading, TP/SL triggers, and kill switch. Operator+ tier.</div><div class="tool-launch">Open</div></div>
        <div class="tool-card" onclick="setTab('agents')"><div class="tool-header"><span class="tool-status">LIVE</span></div><div class="tool-name">Tools Hub</div><div class="tool-desc">Pre-configured AI tools, trading bots, and coding assistants. Auto-plugs your API key.</div><div class="tool-launch">Open</div></div>
        <div class="tool-card" onclick="setTab('keys')"><div class="tool-header"><span class="tool-status">LIVE</span></div><div class="tool-name">Raw API</div><div class="tool-desc">Your API key works with standard SDKs. Drop it into any project, agent, or script.</div><div class="tool-launch">View Key</div></div>
      </div>
    </div>
  `;
}

// ─── Tab: API Keys ───

function renderKeys() {
  const displayKey = STATE.keyVisible ? STATE.apiKeyFull : STATE.apiKey;
  return `
    <div class="page-header">
      <h1 class="page-title">API Keys</h1>
      <p class="page-sub">Your key works as a drop-in replacement for Anthropic and Google API keys</p>
    </div>
    <div class="section">
      <div class="section-title">Your API Key</div>
      <div class="api-key-box">
        <div class="api-key-display">
          <div class="api-key-value" id="apiKeyDisplay">${displayKey || 'No key'}</div>
          <button class="btn-sm primary" onclick="copyText('${STATE.apiKeyFull || ''}')">Copy</button>
        </div>
        <div class="api-key-actions">
          <button class="btn-sm" onclick="toggleKeyVisibility()">${STATE.keyVisible ? 'Hide' : 'Show'}</button>
          <button class="btn-sm" onclick="rotateKey()">Rotate Key</button>
          <button class="btn-sm danger" onclick="revokeKey()">Revoke</button>
        </div>
      </div>
    </div>
    <div class="section">
      <div class="section-title">Quick Start</div>
      <div class="api-key-box">
        <div class="api-key-hint" style="margin-bottom:16px;">Use your INFINITE API key exactly like you'd use a Claude or Gemini key. Just point to our endpoint:</div>
        <div class="api-key-value" style="font-size:12px;line-height:1.8;white-space:pre-wrap;margin-bottom:16px;padding:20px;">
<span style="color:var(--text-muted)">// Works with any HTTP client</span>
<span style="color:var(--blue)">curl</span> ${API_BASE}/v1/chat \\
  -H <span style="color:var(--accent)">"Authorization: Bearer ${STATE.keyVisible ? STATE.apiKeyFull : 'inf_your_key'}"</span> \\
  -d <span style="color:var(--accent)">'{"model":"claude-sonnet-4-5-20250929","messages":[{"role":"user","content":"Hello"}]}'</span></div>
        <div class="api-key-hint">
          <strong style="color:var(--text)">Anthropic Python SDK:</strong><br>
          <code>client = Anthropic(api_key="your_inf_key", base_url="${API_BASE}")</code>
        </div>
      </div>
    </div>
  `;
}

// ─── Tab: Models ───

function renderModels() {
  const allModels = [
    { name: 'claude-sonnet-4-5', provider: 'Anthropic', tier: 'Signal+', live: true },
    { name: 'claude-opus-4-6', provider: 'Anthropic', tier: 'Architect', live: true },
    { name: 'gemini-2.5-pro', provider: 'Google', tier: 'Operator+', live: true },
    { name: 'gemini-2.5-flash', provider: 'Google', tier: 'Signal+', live: true },
  ];
  const userModels = STATE.models || [];
  return `
    <div class="page-header">
      <h1 class="page-title">Available Models</h1>
      <p class="page-sub">Access depends on your tier. Upgrade by holding more $INFINITE.</p>
    </div>
    <div class="section">
      <div class="section-title">AI Models</div>
      <div class="models-list">
        <div class="model-row" style="background:transparent;border-color:transparent;">
          <div class="model-name" style="color:var(--text-muted);font-size:10px;letter-spacing:2px;">MODEL</div>
          <div class="model-provider" style="font-size:10px;letter-spacing:2px;">PROVIDER</div>
          <div class="model-tier" style="font-size:10px;letter-spacing:2px;">MIN TIER</div>
          <div class="model-status" style="font-size:10px;letter-spacing:2px;">STATUS</div>
        </div>
        ${allModels.map(m => {
          const hasAccess = userModels.some(um => um.includes(m.name.split('-')[0]));
          return `<div class="model-row" style="${hasAccess ? '' : 'opacity:0.4'}">
            <div class="model-name">${m.name}</div>
            <div class="model-provider">${m.provider}</div>
            <div class="model-tier">${m.tier}</div>
            <div class="model-status">${hasAccess ? '<span class="live">LIVE</span>' : '<span style="color:var(--text-muted)">LOCKED</span>'}</div>
          </div>`;
        }).join('')}
      </div>
    </div>
  `;
}

// ─── Tab: Connections ───

function renderConnections() {
  const providers = [
    { id: 'github', name: 'GitHub', desc: 'Access private repos, issues, and PRs', icon: 'GH', ready: true },
    { id: 'google', name: 'Google', desc: 'Search Drive, read Docs and Sheets', icon: 'G', ready: false },
    { id: 'notion', name: 'Notion', desc: 'Search pages and query databases', icon: 'N', ready: false },
  ];

  return `
    <div class="page-header">
      <h1 class="page-title">Connections</h1>
      <p class="page-sub">Connect your accounts to let the AI access your private data</p>
    </div>
    <div class="connections-grid">
      ${providers.map(p => {
        const isConnected = STATE.connections[p.id];
        return `
          <div class="card connection-card${!p.ready ? ' coming-soon' : ''}">
            <div class="connection-icon">${p.icon}</div>
            <div class="connection-info">
              <div class="connection-name">${p.name}</div>
              <div class="connection-desc dim">${p.desc}</div>
            </div>
            <div class="connection-action">
              ${!p.ready
                ? '<span class="connection-status coming-soon-label">Coming Soon</span>'
                : isConnected
                  ? `<span class="connection-status connected">Connected</span>
                     <button class="btn-sm danger" onclick="disconnectOAuth('${p.id}')">Disconnect</button>`
                  : `<button class="btn-sm primary" onclick="connectOAuth('${p.id}')">Connect</button>`
              }
            </div>
          </div>
        `;
      }).join('')}
    </div>
    <div class="section" style="margin-top:32px;">
      <div class="section-title">How it works</div>
      <div class="dim" style="max-width:600px;line-height:1.6;">
        When you connect an account, the AI chat can access your private data through that service's API.
        Your OAuth tokens are stored in-memory on the server and tied to your API key.
        You can disconnect at any time.
      </div>
    </div>
  `;
}

async function connectOAuth(provider) {
  try {
    const data = await api('/oauth/' + provider + '/init', { method: 'POST' });
    if (data.url) window.open(data.url, '_blank', 'width=600,height=700');
  } catch (err) {
    showToast(err.message || 'Failed to start OAuth', true);
  }
}

async function disconnectOAuth(provider) {
  try {
    await api('/oauth/' + provider + '/disconnect', { method: 'POST' });
    STATE.connections[provider] = false;
    render();
    showToast(provider + ' disconnected');
  } catch (err) {
    showToast(err.message || 'Failed to disconnect', true);
  }
}

// ─── Tab: AI Chat ───

function renderChat() {
  const conv = getActiveConversation();
  const messages = conv ? conv.messages : [];

  // Set default model if needed
  if (!CHAT.selectedModel && STATE.models.length) CHAT.selectedModel = STATE.models[0];

  setTimeout(() => {
    scrollChat();
    bindCodeCopyButtons();
    document.getElementById('chatInput')?.focus();
  }, 50);

  const isSearchOn = CHAT.enabledTools.includes('web_search');
  const isUrlReaderOn = CHAT.enabledTools.includes('url_reader');
  const isCodeRunnerOn = CHAT.enabledTools.includes('code_runner');
  const isGithubOn = CHAT.enabledTools.includes('github_lookup');
  const isGoogleOn = CHAT.enabledTools.includes('google_lookup');
  const isNotionOn = CHAT.enabledTools.includes('notion_lookup');

  return `
    <div class="chat-with-sidebar">
      <div class="chat-container">
        <div class="chat-header">
          <div class="chat-header-left">
            <select class="chat-model-select" id="chatModelSelect">
              ${(STATE.models || []).map(m =>
                `<option value="${m}" ${m === CHAT.selectedModel ? 'selected' : ''}>${m}</option>`
              ).join('')}
            </select>
            <button class="tool-toggle${isSearchOn ? ' active' : ''}" id="searchToggle">
              <span class="tool-toggle-dot"></span>Search
            </button>
            <button class="tool-toggle${isUrlReaderOn ? ' active' : ''}" id="urlReaderToggle">
              <span class="tool-toggle-dot"></span>Read URL
            </button>
            <button class="tool-toggle${isCodeRunnerOn ? ' active' : ''}" id="codeRunnerToggle">
              <span class="tool-toggle-dot"></span>Run Code
            </button>
            <button class="tool-toggle${isGithubOn ? ' active' : ''}" id="githubToggle">
              <span class="tool-toggle-dot"></span>GitHub
            </button>
            ${STATE.connections.google ? `<button class="tool-toggle${isGoogleOn ? ' active' : ''}" id="googleToggle">
              <span class="tool-toggle-dot"></span>Google
            </button>` : ''}
            ${STATE.connections.notion ? `<button class="tool-toggle${isNotionOn ? ' active' : ''}" id="notionToggle">
              <span class="tool-toggle-dot"></span>Notion
            </button>` : ''}
          </div>
          <div style="display:flex;gap:8px;">
            ${CHAT.conversations.length > 1 ? `
              <select class="chat-model-select" id="chatConvSelect" style="max-width:200px;">
                ${CHAT.conversations.map(c =>
                  `<option value="${c.id}" ${c.id === CHAT.activeId ? 'selected' : ''}>${escapeHtml(c.title)}</option>`
                ).join('')}
              </select>
            ` : ''}
            <button class="btn-sm primary" onclick="newConversation()">+ New</button>
          </div>
        </div>

        <div class="chat-messages" id="chatMessages">
          ${messages.length === 0 ? `
            <div class="chat-empty">
              <div class="chat-empty-icon">/</div>
              <div class="chat-empty-title">Start a conversation</div>
              <div class="chat-empty-sub">Chat with Claude and Gemini. Free, no billing, powered by $INFINITE treasury.</div>
            </div>
          ` : messages.map(m => `
            <div class="chat-message ${m.role}">
              <div class="chat-msg-avatar">${m.role === 'user' ? 'You' : 'AI'}</div>
              <div class="chat-msg-body">
                <div class="chat-msg-name">${m.role === 'user' ? 'You' : (m.model || 'AI')}</div>
                ${m.images ? `<div class="chat-msg-images">${m.images.map(img => `<img src="data:${img.mimeType};base64,${img.data}" alt="uploaded">`).join('')}</div>` : ''}
                <div class="chat-msg-content">${m.role === 'user' ? escapeHtml(m.content) : renderMarkdown(m.content)}</div>
                ${m.sources ? `<div class="search-sources">${m.sources.slice(0,6).map(s => `<a class="search-source-chip" href="${escapeHtml(s.url)}" target="_blank" rel="noopener">${escapeHtml(s.title || s.url)}</a>`).join('')}</div>` : ''}
                ${m.toolResults ? m.toolResults.map(tr => renderToolResultCardHtml(tr.tool, tr.data)).join('') : ''}
              </div>
            </div>
          `).join('')}
        </div>

        ${CHAT.pendingImages.length > 0 ? `
          <div class="chat-image-preview" id="chatImagePreview">
            ${CHAT.pendingImages.map((img, i) => `
              <div class="chat-image-thumb">
                <img src="data:${img.mimeType};base64,${img.data}" alt="upload">
                <button class="remove-img" onclick="removePendingImage(${i})">x</button>
              </div>
            `).join('')}
          </div>
        ` : ''}

        <div class="chat-input-area">
          <button class="chat-upload-btn" id="chatUploadBtn" title="Upload image">+</button>
          <input type="file" id="chatFileInput" accept="image/*" multiple style="display:none;">
          <button class="chat-upload-btn chat-connectors-btn" id="chatConnectorsBtn" title="Connections">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 2v4M10 10v4M4 6h4a2 2 0 012 2v0M8 8h4"/><circle cx="6" cy="2" r="1"/><circle cx="10" cy="14" r="1"/></svg>
            ${Object.values(STATE.connections).some(Boolean) ? '<span class="connectors-dot"></span>' : ''}
          </button>
          <textarea class="chat-input" id="chatInput" placeholder="Message INFINITE..." rows="1"></textarea>
          <button class="chat-send-btn" id="chatSendBtn" ${CHAT.isGenerating ? 'disabled' : ''}>${CHAT.isGenerating ? '...' : '\u2192'}</button>
        </div>
      </div>

      <div class="chat-qa-sidebar">
        <div class="bot-card">
          <div class="bot-card-title">Quick Actions</div>
          <div class="trading-quick-btns">
            <button class="trading-quick-btn" onclick="sendTradingQuery('What are the top trending Solana tokens right now? Analyze volume, social buzz, and on-chain activity.')">Trending</button>
            <button class="trading-quick-btn" onclick="sendTradingQuery('Give me a broad Solana market overview. SOL price action, DEX volumes, new token launches, and overall sentiment.')">Market</button>
            <button class="trading-quick-btn" onclick="sendTradingQuery('What are the biggest risk factors to watch for in the current Solana ecosystem? Any major red flags?')">Risk Check</button>
            <button class="trading-quick-btn" onclick="sendTradingQuery('Find me high-potential alpha opportunities on Solana right now. New protocols, undervalued tokens, or emerging narratives.')">Find Alpha</button>
          </div>
        </div>
        <div class="bot-card">
          <div class="bot-card-title">Token Lookup</div>
          <div class="trading-token-input">
            <input type="text" id="chatTokenAddr" placeholder="Token address...">
            <button class="btn-sm primary" onclick="lookupToken()">Go</button>
          </div>
          <div id="tokenInfoCard"></div>
        </div>
      </div>
    </div>
  `;
}

// ─── Tab: Image Lab ───

function renderImages() {
  if (!STATE.providers.gemini) {
    return `
      <div class="page-header">
        <h1 class="page-title">Image Lab</h1>
        <p class="page-sub">Generate images with Gemini. Describe anything — photorealistic, illustration, concept art.</p>
      </div>
      <div class="video-tier-gate">
        <h3>Coming Soon</h3>
        <p>Image generation will activate after token launch. Powered by Google Gemini.</p>
        <p style="color:var(--text-muted);font-family:var(--font-mono);font-size:11px;margin-top:16px;">This feature requires the Gemini API to be configured by the protocol treasury.</p>
      </div>
    `;
  }

  return `
    <div class="page-header">
      <h1 class="page-title">Image Lab</h1>
      <p class="page-sub">Generate images with Gemini. Describe anything — photorealistic, illustration, concept art.</p>
    </div>
    <div class="image-prompt-area">
      <input type="text" class="image-prompt-input" id="imagePrompt" placeholder="A cyberpunk cityscape at sunset with neon signs..."
        onkeydown="if(event.key==='Enter')generateImage()">
      <button class="image-gen-btn" id="imageGenBtn" onclick="generateImage()" ${IMAGES.isGenerating ? 'disabled' : ''}>
        ${IMAGES.isGenerating ? 'GENERATING...' : 'CREATE'}
      </button>
    </div>
    <div class="section">
      <div class="section-title">Generated Images</div>
      <div class="image-gallery" id="imageGallery">
        ${IMAGES.isGenerating ? `
          <div class="image-loading"><div class="image-spinner"></div><span style="font-family:var(--font-mono);font-size:11px;">Generating image...</span></div>
        ` : IMAGES.gallery.length ? IMAGES.gallery.map(img => `
          <div class="image-card">
            <img src="data:${img.mimeType};base64,${img.data}" alt="${escapeHtml(img.prompt)}" loading="lazy">
            <div class="image-card-footer">
              <div class="image-card-prompt">${escapeHtml(img.prompt)}</div>
              <button class="btn-sm" onclick="downloadImage('${img.data}','${img.mimeType}')">Save</button>
            </div>
          </div>
        `).join('') : `
          <div style="color:var(--text-muted);font-family:var(--font-mono);font-size:12px;padding:60px;text-align:center;">
            No images yet. Describe what you want to create.
          </div>
        `}
      </div>
    </div>
  `;
}

// ─── Video Lab ───

function isVideoTierAllowed() {
  const t = (STATE.tier || '').toLowerCase();
  return t === 'operator' || t === 'architect';
}

function renderVideo() {
  if (!STATE.providers.gemini) {
    return `
      <div class="page-header">
        <h1 class="page-title">Video Lab</h1>
        <p class="page-sub">Generate AI videos with Google Veo 2</p>
      </div>
      <div class="video-tier-gate">
        <h3>Coming Soon</h3>
        <p>Video generation will activate after token launch. Powered by Google Veo 2.</p>
        <p style="color:var(--text-muted);font-family:var(--font-mono);font-size:11px;margin-top:16px;">This feature requires the Gemini API to be configured by the protocol treasury.</p>
      </div>
    `;
  }

  if (!isVideoTierAllowed()) {
    return `
      <div class="page-header">
        <h1 class="page-title">Video Lab</h1>
        <p class="page-sub">Generate AI videos with Google Veo 2</p>
      </div>
      <div class="video-tier-gate">
        <h3>Operator Tier Required</h3>
        <p>Video generation requires Operator tier (100K+ $INFINITE) or above.</p>
        <p style="color:var(--text-muted);font-family:var(--font-mono);font-size:11px;margin-top:16px;">Current: ${STATE.tier || '—'} (${STATE.balance.toLocaleString()} $INFINITE)</p>
      </div>
    `;
  }

  return `
    <div class="page-header">
      <h1 class="page-title">Video Lab</h1>
      <p class="page-sub">Generate AI videos with Google Veo 2. Each generation counts as 10 API calls.</p>
    </div>
    <div class="video-controls">
      <input type="text" class="image-prompt-input" id="videoPrompt" placeholder="A drone shot flying over a futuristic city at night..."
        onkeydown="if(event.key==='Enter')generateVideo()">
      <select class="video-select" id="videoAspect">
        <option value="16:9">16:9</option>
        <option value="9:16">9:16</option>
        <option value="1:1">1:1</option>
      </select>
      <select class="video-select" id="videoDuration">
        <option value="5">5s</option>
        <option value="10">10s</option>
      </select>
      <button class="image-gen-btn" id="videoGenBtn" onclick="generateVideo()" ${VIDEOS.isGenerating ? 'disabled' : ''}>
        ${VIDEOS.isGenerating ? 'GENERATING...' : 'CREATE'}
      </button>
    </div>
    <div class="section">
      <div class="section-title">Generated Videos</div>
      <div class="image-gallery" id="videoGallery">
        ${renderVideoGallery()}
      </div>
    </div>
  `;
}

function renderVideoGallery() {
  if (VIDEOS.gallery.length === 0 && !VIDEOS.isGenerating) {
    return '<div style="color:var(--text-muted);font-family:var(--font-mono);font-size:12px;padding:60px;text-align:center;">No videos yet. Describe what you want to create.</div>';
  }

  return VIDEOS.gallery.map((v, i) => {
    if (v.status === 'pending') {
      return `
        <div class="video-pending">
          <div class="image-spinner"></div>
          <span style="font-family:var(--font-mono);font-size:11px;color:var(--text-muted);">Generating video...</span>
          <span style="font-family:var(--font-mono);font-size:10px;color:var(--text-muted);">Estimated: 1-3 minutes</span>
          <div class="video-card-prompt" style="white-space:normal;text-align:center;padding:0 16px;">${escapeHtml(v.prompt)}</div>
        </div>
      `;
    }
    if (v.status === 'failed') {
      return `
        <div class="video-card" style="border-color:var(--red);">
          <div style="padding:40px;text-align:center;color:var(--red);font-family:var(--font-mono);font-size:12px;">
            Generation failed${v.error ? ': ' + escapeHtml(v.error) : ''}
          </div>
          <div class="video-card-footer">
            <div class="video-card-prompt">${escapeHtml(v.prompt)}</div>
          </div>
        </div>
      `;
    }
    if (!v.uri) {
      return `
        <div class="video-card" style="border-color:var(--red);">
          <div style="padding:40px;text-align:center;color:var(--red);font-family:var(--font-mono);font-size:12px;">No video data returned</div>
          <div class="video-card-footer"><div class="video-card-prompt">${escapeHtml(v.prompt)}</div></div>
        </div>`;
    }
    return `
      <div class="video-card">
        <video controls preload="metadata" src="${v.uri}"></video>
        <div class="video-card-footer">
          <div class="video-card-prompt">${escapeHtml(v.prompt)}</div>
          <button class="btn-sm" onclick="downloadVideo('${v.uri}')">Save</button>
        </div>
      </div>
    `;
  }).join('');
}

async function generateVideo() {
  const input = document.getElementById('videoPrompt');
  if (!input) return;
  const prompt = input.value.trim();
  if (!prompt || VIDEOS.isGenerating) return;

  const aspectRatio = document.getElementById('videoAspect')?.value || '16:9';
  const duration = parseInt(document.getElementById('videoDuration')?.value || '5');

  VIDEOS.isGenerating = true;
  const entry = { prompt, status: 'pending', operationName: null, uri: null, error: null, createdAt: Date.now() };
  VIDEOS.gallery.unshift(entry);
  input.value = '';
  renderVideoState();

  try {
    const data = await api('/v1/video/generate', {
      method: 'POST',
      body: JSON.stringify({ prompt, aspectRatio, duration }),
    });
    entry.operationName = data.operationName;
    startVideoPolling(entry);
    saveVideoHistory();
  } catch (err) {
    entry.status = 'failed';
    entry.error = err.message || 'Generation failed';
    VIDEOS.isGenerating = false;
    renderVideoState();
    showToast(err.message || 'Video generation failed', true);
  }
}

function startVideoPolling(entry) {
  if (!entry.operationName) return;

  let failures = 0;
  const MAX_FAILURES = 36; // 3 minutes at 5s intervals

  const intervalId = setInterval(async () => {
    try {
      const data = await api(`/v1/video/status/${entry.operationName}`);
      failures = 0;

      if (data.status === 'complete') {
        entry.status = 'complete';
        entry.uri = data.video?.uri ? `${API_BASE}${data.video.uri}` : null;
        clearInterval(intervalId);
        VIDEOS.pollIntervals.delete(entry.operationName);
        VIDEOS.isGenerating = false;
        saveVideoHistory();
        renderVideoState();
      } else if (data.status === 'failed') {
        entry.status = 'failed';
        entry.error = data.error || 'Unknown error';
        clearInterval(intervalId);
        VIDEOS.pollIntervals.delete(entry.operationName);
        VIDEOS.isGenerating = false;
        saveVideoHistory();
        renderVideoState();
      }
    } catch (err) {
      failures++;
      console.error('Video poll error:', err.message, `(${failures}/${MAX_FAILURES})`);
      if (failures >= MAX_FAILURES) {
        entry.status = 'failed';
        entry.error = 'Timed out waiting for video';
        clearInterval(intervalId);
        VIDEOS.pollIntervals.delete(entry.operationName);
        VIDEOS.isGenerating = false;
        renderVideoState();
      }
    }
  }, 5000);

  VIDEOS.pollIntervals.set(entry.operationName, intervalId);
}

function renderVideoState() {
  const gallery = document.getElementById('videoGallery');
  const btn = document.getElementById('videoGenBtn');
  if (btn) {
    btn.disabled = VIDEOS.isGenerating;
    btn.textContent = VIDEOS.isGenerating ? 'GENERATING...' : 'CREATE';
  }
  if (gallery) gallery.innerHTML = renderVideoGallery();
}

function downloadVideo(uri) {
  const link = document.createElement('a');
  link.href = uri;
  link.download = `infinite-video-${Date.now()}.mp4`;
  link.target = '_blank';
  link.click();
}

function saveVideoHistory() {
  try {
    const toSave = VIDEOS.gallery
      .filter(v => v.status === 'complete' && v.uri)
      .slice(0, 20)
      .map(v => ({ prompt: v.prompt, uri: v.uri, status: v.status, createdAt: v.createdAt }));
    localStorage.setItem('infinite_videos', JSON.stringify(toSave));
  } catch {}
}

function loadVideoHistory() {
  try {
    const raw = localStorage.getItem('infinite_videos');
    if (!raw) return;
    const data = JSON.parse(raw);
    VIDEOS.gallery = (data || []).filter(v => v.uri);
  } catch {}
}

// ─── Trade Bot Panel ───

function getActiveTradingConversation() {
  if (!TRADING.activeId) {
    const conv = { id: 'tconv_' + Date.now(), messages: [] };
    TRADING.conversations.push(conv);
    TRADING.activeId = conv.id;
  }
  return TRADING.conversations.find(c => c.id === TRADING.activeId);
}

async function initTradingWallet() {
  try {
    const res = await api('/v1/trading/wallet/create', { method: 'POST' });
    TRADING.wallet = { publicKey: res.publicKey, solBalance: 0 };
    await fetchTradingState();
    render();
  } catch (err) {
    console.error('Wallet creation failed:', err.message);
  }
}

async function fetchTradingState() {
  if (STATE.activeTab !== 'trading') return;
  if (TRADING._endpointsDead) return;

  try {
    const walletInfo = await api('/v1/trading/wallet/info');
    TRADING.wallet = { publicKey: walletInfo.publicKey, solBalance: walletInfo.solBalance };
    TRADING.positions = walletInfo.positions || [];
    TRADING._fetchFailCount = 0;
  } catch (err) {
    TRADING._fetchFailCount = (TRADING._fetchFailCount || 0) + 1;
    if (err.status === 404) { TRADING.wallet = null; return; }
    if (err.status === 403 || err.status === 502 || err.status === 500 || err.status === 0) {
      TRADING._endpointsDead = true; stopBotPolling(); return;
    }
    if (TRADING._fetchFailCount >= 2) { TRADING._endpointsDead = true; stopBotPolling(); return; }
    return;
  }

  try {
    const results = await Promise.allSettled([
      api('/v1/trading/portfolio'),
      api('/v1/trading/dca/orders'),
      api('/v1/trading/copy/targets'),
      api('/v1/trading/trigger/list'),
      api('/v1/trading/safety/status'),
      api('/v1/trading/history?limit=50'),
    ]);
    if (results[0].status === 'fulfilled') TRADING.portfolio = results[0].value || null;
    if (results[1].status === 'fulfilled') TRADING.dcaOrders = results[1].value || [];
    if (results[2].status === 'fulfilled') TRADING.copyTargets = results[2].value?.targets || [];
    if (results[3].status === 'fulfilled') TRADING.triggers = results[3].value || [];
    if (results[4].status === 'fulfilled') TRADING.safety = results[4].value || null;
    if (results[5].status === 'fulfilled') TRADING.history = results[5].value || [];
  } catch {}
}

function startBotPolling() {
  if (TRADING.pollInterval || TRADING._endpointsDead) return;
  TRADING._fetchFailCount = 0;
  fetchTradingState().then(() => {
    if (TRADING.pollInterval || TRADING._endpointsDead) return;
    TRADING.pollInterval = setInterval(async () => {
      await fetchTradingState();
      if (STATE.activeTab === 'trading') renderBotPanelContent();
    }, 15000);
  });
}

function stopBotPolling() {
  if (TRADING.pollInterval) { clearInterval(TRADING.pollInterval); TRADING.pollInterval = null; }
}

function setBotPanel(panel) {
  TRADING.activePanel = panel;
  renderBotPanelContent();
}

function renderBotPanelContent() {
  const main = document.getElementById('botMainPanel');
  if (!main) return;
  switch (TRADING.activePanel) {
    case 'portfolio': main.innerHTML = renderBotPortfolio(); break;
    case 'overview': main.innerHTML = renderBotOverview(); break;
    case 'swap': main.innerHTML = renderBotSwap(); break;
    case 'dca': main.innerHTML = renderBotDCA(); break;
    case 'copy': main.innerHTML = renderBotCopy(); break;
    case 'triggers': main.innerHTML = renderBotTriggers(); break;
    case 'history': main.innerHTML = renderBotHistory(); break;
  }
  // Re-bind sidebar nav active state
  document.querySelectorAll('.bot-nav-item').forEach(el => {
    el.classList.toggle('active', el.dataset.panel === TRADING.activePanel);
  });
}

function renderTrading() {
  const isTradingTier = STATE.tier === 'Operator' || STATE.tier === 'Architect';

  if (!isTradingTier) {
    return `<div class="bot-empty"><div class="bot-empty-icon">/</div><div>Trade Bot requires <strong>Operator</strong> tier or above.</div><div style="margin-top:8px;font-size:10px;color:var(--text-muted);">Hold 100K+ $INFINITE tokens to unlock.</div></div>`;
  }

  setTimeout(() => {
    startBotPolling();
  }, 50);

  const w = TRADING.wallet;
  const safety = TRADING.safety;
  const pnl = safety?.dailyPnlSol || 0;
  const pnlClass = pnl >= 0 ? 'positive' : 'negative';
  const pnlStr = (pnl >= 0 ? '+' : '') + pnl.toFixed(4);
  const isKilled = safety?.isKilled || safety?.isCooldown;
  const dcaActive = TRADING.dcaOrders.filter(d => d.status === 'active').length;
  const copyActive = TRADING.copyTargets.filter(t => !t.isPaused).length;
  const trigActive = TRADING.triggers.filter(t => t.status === 'active').length;

  return `
    <div class="bot-layout">
      <div class="bot-sidebar">
        ${w ? `
          <div class="bot-card">
            <div class="bot-card-title">Wallet</div>
            <div class="bot-wallet-addr" onclick="copyText('${w.publicKey}')" title="Click to copy address" style="cursor:pointer;">
              ${w.publicKey.slice(0, 6)}...${w.publicKey.slice(-4)}
              <span style="color:var(--accent);font-size:9px;margin-left:4px;">COPY</span>
            </div>
            <div class="bot-wallet-bal">${(w.solBalance || 0).toFixed(4)} SOL</div>
            <div class="bot-wallet-bal-label">Available Balance</div>
            <div class="bot-wallet-actions">
              <button class="bot-wallet-action-btn" onclick="copyText('${w.publicKey}')">Copy Address</button>
              <button class="bot-wallet-action-btn" onclick="exportBotPrivateKey()">Export Key</button>
            </div>
          </div>
        ` : `
          <div class="bot-card">
            <div class="bot-card-title">Wallet</div>
            <div style="text-align:center;padding:12px 0;">
              <button class="bot-form-submit" onclick="initTradingWallet()" style="font-size:10px;padding:10px 16px;">Create Burner Wallet</button>
            </div>
          </div>
        `}

        ${w ? `
          <div class="bot-card">
            <div class="bot-card-title">Quick Trade</div>
            <div class="bot-quick-trade">
              <input class="bot-input" id="botQtToken" placeholder="Token address">
              <input class="bot-input" id="botQtAmount" placeholder="SOL amount" type="number" step="0.01">
              <div class="bot-trade-btns">
                <button class="bot-btn-buy" onclick="executeQuickTrade('buy')">BUY</button>
                <button class="bot-btn-sell" onclick="executeQuickTrade('sell')">SELL</button>
              </div>
            </div>
          </div>
        ` : ''}

        <div class="bot-card">
          <div class="bot-card-title">Panels</div>
          <div class="bot-nav-list">
            <div class="bot-nav-item ${TRADING.activePanel === 'portfolio' ? 'active' : ''}" data-panel="portfolio" onclick="setBotPanel('portfolio')">Portfolio</div>
            <div class="bot-nav-item ${TRADING.activePanel === 'overview' ? 'active' : ''}" data-panel="overview" onclick="setBotPanel('overview')">Positions</div>
            <div class="bot-nav-item ${TRADING.activePanel === 'swap' ? 'active' : ''}" data-panel="swap" onclick="setBotPanel('swap')">Swap</div>
            <div class="bot-nav-item ${TRADING.activePanel === 'dca' ? 'active' : ''}" data-panel="dca" onclick="setBotPanel('dca')">DCA <span class="bot-nav-count">${dcaActive}</span></div>
            <div class="bot-nav-item ${TRADING.activePanel === 'copy' ? 'active' : ''}" data-panel="copy" onclick="setBotPanel('copy')">Copy Trade <span class="bot-nav-count">${copyActive}</span></div>
            <div class="bot-nav-item ${TRADING.activePanel === 'triggers' ? 'active' : ''}" data-panel="triggers" onclick="setBotPanel('triggers')">Triggers <span class="bot-nav-count">${trigActive}</span></div>
            <div class="bot-nav-item ${TRADING.activePanel === 'history' ? 'active' : ''}" data-panel="history" onclick="setBotPanel('history')">History</div>
          </div>
        </div>

        <div class="bot-card">
          <div class="bot-card-title">Safety <span class="badge ${isKilled ? 'badge-stopped' : 'badge-live'}">${isKilled ? 'STOPPED' : 'ACTIVE'}</span></div>
          <div class="bot-pnl ${pnlClass}">PnL: ${pnlStr} SOL</div>
          <div style="font-family:var(--font-mono);font-size:9px;color:var(--text-muted);margin-bottom:10px;">Trades today: ${safety?.dailyTrades || 0}</div>
          ${isKilled
            ? `<button class="bot-resume-btn" onclick="botResume()">RESUME TRADING</button>`
            : `<button class="bot-kill-btn" onclick="botKill()">KILL SWITCH</button>`
          }
        </div>
      </div>
      <div class="bot-main" id="botMainPanel">
        ${renderBotPortfolio()}
      </div>
    </div>
  `;
}

function renderBotPortfolio() {
  const p = TRADING.portfolio;
  if (!p) return `<div><div class="bot-empty"><div class="bot-empty-icon">/</div>Loading portfolio...</div></div>`;

  const sol = p.solBalance || 0;
  const solUsd = p.solValueUsd || 0;
  const totalUsd = p.totalValueUsd || 0;
  const holdings = p.holdings || [];
  const solPrice = p.solPriceUsd || 0;

  return `<div>
    <h2>Portfolio</h2>
    <div class="portfolio-summary">
      <div class="portfolio-stat-card">
        <div class="label">Total Value</div>
        <div class="val accent">$${totalUsd.toFixed(2)}</div>
      </div>
      <div class="portfolio-stat-card">
        <div class="label">SOL Balance</div>
        <div class="val">${sol.toFixed(4)}</div>
      </div>
      <div class="portfolio-stat-card">
        <div class="label">Tokens Held</div>
        <div class="val">${holdings.length}</div>
      </div>
      <div class="portfolio-stat-card">
        <div class="label">SOL Price</div>
        <div class="val">$${solPrice.toFixed(2)}</div>
      </div>
    </div>

    <h2>Holdings</h2>
    <div class="portfolio-holdings">
      <div class="portfolio-sol-row">
        <div>
          <div style="font-weight:600;">SOL</div>
          <div class="token-mint">Native</div>
        </div>
        <div class="token-amount">${sol.toFixed(4)}</div>
        <div class="token-value">$${solUsd.toFixed(2)}</div>
      </div>
      ${holdings.length === 0 ? '<div class="bot-empty" style="padding:24px 0;">No token holdings</div>' : holdings.map(h => `
        <div class="portfolio-row" onclick="copyText('${h.mint}')" title="Click to copy mint">
          <div>
            <div>${h.mint.slice(0, 4)}...${h.mint.slice(-4)}</div>
            <div class="token-mint">${h.mint}</div>
          </div>
          <div class="token-amount">${formatCompact(h.amount)}</div>
          <div class="token-value">${h.valueUsd > 0 ? '$' + h.valueUsd.toFixed(2) : '—'}</div>
        </div>
      `).join('')}
    </div>
  </div>`;
}

function renderBotOverview() {
  const positions = TRADING.positions || [];
  return `<div>
    <h2>Positions (${positions.length})</h2>
    ${positions.length === 0
      ? '<div class="bot-empty"><div class="bot-empty-icon">/</div>No open positions</div>'
      : `<div class="bot-positions-grid">${positions.map(p => `
        <div class="bot-position-card">
          <div class="bot-position-token">${p.mint?.slice(0, 8) || 'Unknown'}...</div>
          <div class="bot-position-mint">${p.mint || '—'}</div>
          <div class="bot-position-stats">
            <div class="bot-position-stat"><div class="label">Amount</div><div class="val">${formatCompact(p.amount || 0)}</div></div>
            <div class="bot-position-stat"><div class="label">Avg Price</div><div class="val">${p.avgPrice ? formatTokenPrice(p.avgPrice) : '—'}</div></div>
          </div>
        </div>`).join('')}</div>`
    }
    <h2 style="margin-top:24px;">Recent Trades</h2>
    ${renderBotHistoryTable(TRADING.history.slice(-10))}
  </div>`;
}

function renderBotSwap() {
  return `<div>
    <h2>Jupiter Swap</h2>
    <div class="bot-form">
      <div class="bot-form-row"><label class="bot-form-label">Input Mint</label><input class="bot-form-input" id="swapInputMint" value="So11111111111111111111111111111111111111112" placeholder="SOL mint"></div>
      <div class="bot-form-row"><label class="bot-form-label">Output Mint</label><input class="bot-form-input" id="swapOutputMint" placeholder="Token mint address"></div>
      <div class="bot-form-row"><label class="bot-form-label">Amount (lamports)</label><input class="bot-form-input" id="swapAmount" type="number" placeholder="e.g. 100000000 = 0.1 SOL"></div>
      <div class="bot-form-row"><label class="bot-form-label">Slippage (bps)</label><input class="bot-form-input" id="swapSlippage" type="number" value="300" placeholder="300 = 3%"></div>
      <button class="bot-form-submit" onclick="executeSwapForm()">Execute Swap</button>
      <div id="swapResult" style="font-family:var(--font-mono);font-size:11px;color:var(--text-dim);"></div>
    </div>
  </div>`;
}

function renderBotDCA() {
  const orders = TRADING.dcaOrders || [];
  return `<div>
    <h2>DCA Orders</h2>
    <div class="bot-form" style="margin-bottom:24px;">
      <div class="bot-form-row"><label class="bot-form-label">Input Mint (from)</label><input class="bot-form-input" id="dcaInputMint" value="So11111111111111111111111111111111111111112"></div>
      <div class="bot-form-row"><label class="bot-form-label">Output Mint (to)</label><input class="bot-form-input" id="dcaOutputMint" placeholder="Token mint"></div>
      <div class="bot-form-row"><label class="bot-form-label">Total Amount (lamports)</label><input class="bot-form-input" id="dcaTotal" type="number" placeholder="e.g. 500000000 = 0.5 SOL"></div>
      <div class="bot-form-row"><label class="bot-form-label">Per Cycle (lamports)</label><input class="bot-form-input" id="dcaPerCycle" type="number" placeholder="e.g. 100000000 = 0.1 SOL"></div>
      <div class="bot-form-row"><label class="bot-form-label">Interval (seconds)</label><input class="bot-form-input" id="dcaInterval" type="number" value="3600" placeholder="3600 = 1 hour"></div>
      <button class="bot-form-submit" onclick="createDCA()">Create DCA Order</button>
    </div>
    <h2>Active Orders (${orders.length})</h2>
    <div class="bot-list">
      ${orders.length === 0 ? '<div class="bot-empty">No DCA orders</div>' : orders.map(o => `
        <div class="bot-list-item">
          <div>
            <div class="bot-list-info">${o.inputMint?.slice(0, 6)}... → ${o.outputMint?.slice(0, 6)}...</div>
            <div class="bot-list-sub">${o.cyclesCompleted}/${o.maxCycles} cycles | ${o.status}</div>
          </div>
          ${o.status === 'active' || o.status === 'paused' ? `<button class="bot-list-action" onclick="cancelDCA('${o.id}')">Cancel</button>` : ''}
        </div>
      `).join('')}
    </div>
  </div>`;
}

function renderBotCopy() {
  const targets = TRADING.copyTargets || [];
  return `<div>
    <h2>Copy Trading</h2>
    <div class="bot-form" style="margin-bottom:24px;">
      <div class="bot-form-row"><label class="bot-form-label">Wallet Address to Follow</label><input class="bot-form-input" id="copyAddress" placeholder="Solana wallet address"></div>
      <div class="bot-form-row"><label class="bot-form-label">Max Position (SOL)</label><input class="bot-form-input" id="copyMaxSol" type="number" value="0.5" step="0.1"></div>
      <div class="bot-form-row"><label class="bot-form-label">Multiplier</label><input class="bot-form-input" id="copyMultiplier" type="number" value="1.0" step="0.1"></div>
      <button class="bot-form-submit" onclick="followWallet()">Follow Wallet</button>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:16px;">
      <button class="bot-form-submit" onclick="startCopyTrading()" style="flex:1;background:var(--green);font-size:10px;padding:8px;">Start Monitoring</button>
      <button class="bot-form-submit" onclick="stopCopyTrading()" style="flex:1;background:var(--red);font-size:10px;padding:8px;">Stop</button>
    </div>
    <h2>Followed Wallets (${targets.length})</h2>
    <div class="bot-list">
      ${targets.length === 0 ? '<div class="bot-empty">No wallets followed</div>' : targets.map(t => `
        <div class="bot-list-item">
          <div>
            <div class="bot-list-info">${t.name || t.address?.slice(0, 8)}...</div>
            <div class="bot-list-sub">${t.tradesCopied || 0} trades copied | ${t.isPaused ? 'Paused' : 'Active'}</div>
          </div>
          <button class="bot-list-action" onclick="unfollowWallet('${t.id}')">Remove</button>
        </div>
      `).join('')}
    </div>
  </div>`;
}

function renderBotTriggers() {
  const triggers = TRADING.triggers || [];
  return `<div>
    <h2>Conditional Orders (TP / SL / Sniper)</h2>
    <div class="bot-form" style="margin-bottom:24px;">
      <div class="bot-form-row"><label class="bot-form-label">Token Mint</label><input class="bot-form-input" id="trigMint" placeholder="Token mint"></div>
      <div class="bot-form-row"><label class="bot-form-label">Condition Type</label>
        <select class="bot-form-input" id="trigCondType"><option value="price_above">Price Above (TP)</option><option value="price_below">Price Below (SL)</option><option value="price_cross">Price Cross</option></select>
      </div>
      <div class="bot-form-row"><label class="bot-form-label">Target Price (USD)</label><input class="bot-form-input" id="trigPrice" type="number" step="any"></div>
      <div class="bot-form-row"><label class="bot-form-label">Action</label>
        <select class="bot-form-input" id="trigAction"><option value="sell">Sell</option><option value="buy">Buy</option></select>
      </div>
      <div class="bot-form-row"><label class="bot-form-label">Amount (lamports)</label><input class="bot-form-input" id="trigAmount" type="number"></div>
      <button class="bot-form-submit" onclick="createTrigger()">Create Trigger</button>
    </div>
    <h2>Active Triggers (${triggers.filter(t => t.status === 'active').length})</h2>
    <div class="bot-list">
      ${triggers.length === 0 ? '<div class="bot-empty">No triggers set</div>' : triggers.map(t => `
        <div class="bot-list-item">
          <div>
            <div class="bot-list-info">${t.condition?.type} @ $${t.condition?.price || '?'}</div>
            <div class="bot-list-sub">${t.mint?.slice(0, 8)}... | ${t.status}</div>
          </div>
          ${t.status === 'active' ? `<button class="bot-list-action" onclick="cancelTrigger('${t.id}')">Cancel</button>` : ''}
        </div>
      `).join('')}
    </div>
  </div>`;
}

function renderBotHistory() {
  return `<div>
    <h2>Trade History</h2>
    ${renderBotHistoryTable(TRADING.history)}
  </div>`;
}

function renderBotHistoryTable(entries) {
  if (!entries || entries.length === 0) return '<div class="bot-empty">No trades yet</div>';
  return `
    <table class="bot-history-table">
      <thead><tr><th>Time</th><th>Action</th><th>Token</th><th>Signature</th></tr></thead>
      <tbody>
        ${entries.slice().reverse().map(t => `
          <tr>
            <td>${new Date(t.ts).toLocaleTimeString()}</td>
            <td>${t.action || '—'}</td>
            <td>${t.mint ? t.mint.slice(0, 8) + '...' : t.inputMint ? t.inputMint.slice(0, 6) + '→' + (t.outputMint||'').slice(0, 6) : '—'}</td>
            <td>${t.sig ? '<a href="https://solscan.io/tx/' + t.sig + '" target="_blank" style="color:var(--accent);">' + t.sig.slice(0, 8) + '...</a>' : '—'}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

// ─── Bot Actions ───

async function exportBotPrivateKey() {
  if (!confirm('This will display your private key. Never share it with anyone. Continue?')) return;
  try {
    const res = await api('/v1/trading/wallet/export', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ confirm: true }),
    });
    const key = res.privateKey || res.secretKey || '';
    if (key) {
      await navigator.clipboard.writeText(key);
      alert('Private key copied to clipboard.');
    } else {
      alert('Could not retrieve private key.');
    }
  } catch (err) {
    alert('Export failed: ' + (err.message || 'Unknown error'));
  }
}

async function executeQuickTrade(action) {
  const token = document.getElementById('botQtToken')?.value.trim();
  const amount = parseFloat(document.getElementById('botQtAmount')?.value);
  if (!token || !amount || amount <= 0) return;
  try {
    const endpoint = `/v1/trading/pump/${action}`;
    const res = await api(endpoint, { method: 'POST', body: JSON.stringify({ mint: token, amount, denominatedInSol: true, slippage: 15 }) });
    await fetchTradingState();
    render();
  } catch (err) {
    console.error(`Quick ${action} failed:`, err.message);
  }
}

async function executeSwapForm() {
  const result = document.getElementById('swapResult');
  const inputMint = document.getElementById('swapInputMint')?.value.trim();
  const outputMint = document.getElementById('swapOutputMint')?.value.trim();
  const amount = document.getElementById('swapAmount')?.value.trim();
  const slippageBps = parseInt(document.getElementById('swapSlippage')?.value) || 300;
  if (!inputMint || !outputMint || !amount) { if (result) result.textContent = 'Fill all fields'; return; }
  if (result) result.textContent = 'Executing...';
  try {
    const res = await api('/v1/trading/swap', { method: 'POST', body: JSON.stringify({ inputMint, outputMint, amount, slippageBps }) });
    if (result) result.innerHTML = 'Success: <a href="https://solscan.io/tx/' + res.signature + '" target="_blank" style="color:var(--accent);">' + res.signature.slice(0, 16) + '...</a>';
    await fetchTradingState();
  } catch (err) {
    if (result) result.textContent = 'Failed: ' + err.message;
  }
}

async function createDCA() {
  const inputMint = document.getElementById('dcaInputMint')?.value.trim();
  const outputMint = document.getElementById('dcaOutputMint')?.value.trim();
  const total = parseInt(document.getElementById('dcaTotal')?.value);
  const perCycle = parseInt(document.getElementById('dcaPerCycle')?.value);
  const interval = parseInt(document.getElementById('dcaInterval')?.value) * 1000;
  if (!inputMint || !outputMint || !total || !perCycle || !interval) return;
  try {
    await api('/v1/trading/dca/create', { method: 'POST', body: JSON.stringify({ inputMint, outputMint, totalAmountLamports: total, amountPerCycleLamports: perCycle, cycleIntervalMs: interval }) });
    await fetchTradingState();
    renderBotPanelContent();
  } catch (err) {
    console.error('DCA create failed:', err.message);
  }
}

async function cancelDCA(id) {
  try {
    await api(`/v1/trading/dca/${id}/cancel`, { method: 'POST' });
    await fetchTradingState();
    renderBotPanelContent();
  } catch (err) {
    console.error('DCA cancel failed:', err.message);
  }
}

async function followWallet() {
  const address = document.getElementById('copyAddress')?.value.trim();
  const maxPositionSol = parseFloat(document.getElementById('copyMaxSol')?.value) || 0.5;
  const multiplier = parseFloat(document.getElementById('copyMultiplier')?.value) || 1.0;
  if (!address) return;
  try {
    await api('/v1/trading/copy/follow', { method: 'POST', body: JSON.stringify({ address, maxPositionSol, multiplier }) });
    await fetchTradingState();
    renderBotPanelContent();
  } catch (err) {
    console.error('Follow failed:', err.message);
  }
}

async function unfollowWallet(targetId) {
  try {
    await api('/v1/trading/copy/unfollow', { method: 'POST', body: JSON.stringify({ targetId }) });
    await fetchTradingState();
    renderBotPanelContent();
  } catch (err) {
    console.error('Unfollow failed:', err.message);
  }
}

async function startCopyTrading() {
  try { await api('/v1/trading/copy/start', { method: 'POST' }); } catch (err) { console.error(err.message); }
}

async function stopCopyTrading() {
  try { await api('/v1/trading/copy/stop', { method: 'POST' }); } catch (err) { console.error(err.message); }
}

async function createTrigger() {
  const mint = document.getElementById('trigMint')?.value.trim();
  const condType = document.getElementById('trigCondType')?.value;
  const price = parseFloat(document.getElementById('trigPrice')?.value);
  const action = document.getElementById('trigAction')?.value;
  const amount = document.getElementById('trigAmount')?.value;
  if (!mint || !condType || !price || !action || !amount) return;

  const inputMint = action === 'buy' ? 'So11111111111111111111111111111111111111112' : mint;
  const outputMint = action === 'buy' ? mint : 'So11111111111111111111111111111111111111112';

  try {
    await api('/v1/trading/trigger/create', { method: 'POST', body: JSON.stringify({
      mint, condition: { type: condType, price }, order: { action, inputMint, outputMint, amount, slippageBps: 500 }
    })});
    await fetchTradingState();
    renderBotPanelContent();
  } catch (err) {
    console.error('Trigger create failed:', err.message);
  }
}

async function cancelTrigger(id) {
  try {
    await api(`/v1/trading/trigger/${id}/cancel`, { method: 'POST' });
    await fetchTradingState();
    renderBotPanelContent();
  } catch (err) {
    console.error('Trigger cancel failed:', err.message);
  }
}

async function botKill() {
  try {
    await api('/v1/trading/safety/kill', { method: 'POST', body: JSON.stringify({ reason: 'Dashboard kill switch' }) });
    await fetchTradingState();
    render();
  } catch (err) {
    console.error('Kill switch failed:', err.message);
  }
}

async function botResume() {
  try {
    await api('/v1/trading/safety/resume', { method: 'POST' });
    await fetchTradingState();
    render();
  } catch (err) {
    console.error('Resume failed:', err.message);
  }
}

async function lookupToken() {
  const input = document.getElementById('chatTokenAddr');
  if (!input) return;
  const address = input.value.trim();
  if (!address) return;

  const card = document.getElementById('tokenInfoCard');
  if (card) card.innerHTML = '<div style="padding:12px;text-align:center;"><div class="image-spinner" style="margin:0 auto;"></div></div>';

  try {
    const info = await api(`/v1/trading/token/${address}`);
    TRADING.tokenInfo = info;
    renderTokenInfoCard(info);
    // Auto-trigger analysis via chat
    sendTradingQuery(`Analyze this token in detail: ${info.name || 'Unknown'} (${info.symbol || '?'}) at address ${address}. Give me a full breakdown: risk level, liquidity analysis, price action assessment, and whether it looks like a good opportunity right now.`, address);
  } catch (err) {
    if (card) card.innerHTML = `<div style="padding:12px;color:var(--red);font-family:var(--font-mono);font-size:11px;">Lookup failed: ${escapeHtml(err.message || 'Unknown error')}</div>`;
  }
}

function renderTokenInfoCard(info) {
  const card = document.getElementById('tokenInfoCard');
  if (!card) return;

  const changeClass = (info.change24h || 0) >= 0 ? 'green' : 'red';
  const changePrefix = (info.change24h || 0) >= 0 ? '+' : '';

  card.innerHTML = `
    <div class="token-info-card" style="margin-top:12px;">
      <div class="token-info-header">
        <span class="token-info-name">${escapeHtml(info.name || 'Unknown')}</span>
        <span class="token-info-symbol">$${escapeHtml(info.symbol || '?')}</span>
      </div>
      <div class="token-info-stats">
        <div class="token-info-stat"><div class="label">Price</div><div class="val">${info.price ? '$' + formatTokenPrice(info.price) : '—'}</div></div>
        <div class="token-info-stat"><div class="label">24h</div><div class="val ${changeClass}">${info.change24h !== null ? changePrefix + info.change24h + '%' : '—'}</div></div>
        <div class="token-info-stat"><div class="label">Mkt Cap</div><div class="val">${info.marketCap ? '$' + formatCompact(info.marketCap) : '—'}</div></div>
        <div class="token-info-stat"><div class="label">Liquidity</div><div class="val">${info.liquidity ? '$' + formatCompact(info.liquidity) : '—'}</div></div>
      </div>
    </div>
  `;
}

function formatCompact(num) {
  if (num >= 1_000_000_000) return (num / 1_000_000_000).toFixed(1) + 'B';
  if (num >= 1_000_000) return (num / 1_000_000).toFixed(1) + 'M';
  if (num >= 1_000) return (num / 1_000).toFixed(1) + 'K';
  return num.toFixed(0);
}

function formatTokenPrice(price) {
  if (price < 0.0001) return price.toExponential(2);
  if (price < 1) return price.toFixed(6);
  if (price < 100) return price.toFixed(4);
  return price.toFixed(2);
}

function sendTradingQuery(preset, tokenAddress) {
  // Route to AI Chat tab
  setTab('chat');
  setTimeout(() => {
    const input = document.getElementById('chatInput');
    if (input && preset) {
      input.value = preset;
      sendChatMessage();
    }
  }, 100);
}

async function sendTradingMessage(tokenAddress) {
  const input = document.getElementById('tradingInput');
  if (!input) return;
  const text = input.value.trim();
  if (!text || TRADING.isGenerating) return;

  input.value = '';
  input.style.height = 'auto';

  const conv = getActiveTradingConversation();
  conv.messages.push({ role: 'user', content: text });

  appendTradingMessageToDOM({ role: 'user', content: text });
  showTradingTypingIndicator();
  TRADING.isGenerating = true;
  updateTradingSendButton();

  const model = TRADING.selectedModel || STATE.models[0] || 'claude-sonnet-4-5-20250929';

  try {
    TRADING.abortController = new AbortController();

    const systemPrompt = `You are an expert Solana trading analyst. Provide concise, data-driven analysis. When given a token address, analyze its trading metrics, liquidity, holder distribution, and risk factors. Format responses with clear sections. Use markdown tables for comparisons. Always include a risk assessment (Low/Medium/High/Critical).${tokenAddress ? ` The user is asking about token: ${tokenAddress}` : ''}`;

    const body = {
      model,
      messages: [
        { role: 'user', content: systemPrompt },
        { role: 'assistant', content: 'Understood. I\'ll provide concise, data-driven Solana trading analysis.' },
        ...conv.messages.map(m => ({ role: m.role, content: m.content })),
      ],
    };

    const response = await fetch(`${API_BASE}/v1/chat/stream`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${STATE.apiKeyFull}`,
      },
      body: JSON.stringify(body),
      signal: TRADING.abortController.signal,
    });

    if (!response.ok) {
      const err = await response.json().catch(() => ({ message: `HTTP ${response.status}` }));
      throw new Error(err.message || 'Request failed');
    }

    removeTradingTypingIndicator();

    const msgEl = appendTradingMessageToDOM({ role: 'assistant', content: '' });
    const contentEl = msgEl.querySelector('.chat-msg-content');

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let fullText = '';
    let buffer = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop() || '';

      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        const jsonStr = line.slice(6).trim();
        if (!jsonStr) continue;
        try {
          const data = JSON.parse(jsonStr);
          if (data.type === 'text') {
            fullText += data.content;
            contentEl.innerHTML = renderMarkdown(fullText);
            scrollTradingChat();
          } else if (data.type === 'error') {
            throw new Error(data.message);
          }
        } catch (e) {
          if (e.message && !e.message.includes('JSON')) throw e;
        }
      }
    }

    conv.messages.push({ role: 'assistant', content: fullText });
    saveTradingHistory();
    bindCodeCopyButtons();

  } catch (err) {
    removeTradingTypingIndicator();
    if (err.name !== 'AbortError') {
      appendTradingMessageToDOM({ role: 'assistant', content: `Error: ${err.message}`, isError: true });
    }
  } finally {
    TRADING.isGenerating = false;
    TRADING.abortController = null;
    updateTradingSendButton();
  }
}

function appendTradingMessageToDOM(msg) {
  const container = document.getElementById('tradingMessages');
  if (!container) return null;

  const empty = container.querySelector('.chat-empty');
  if (empty) empty.remove();

  const el = document.createElement('div');
  el.className = `chat-message ${msg.role}`;
  el.innerHTML = `
    <div class="chat-msg-avatar">${msg.role === 'user' ? 'You' : 'AI'}</div>
    <div class="chat-msg-body">
      <div class="chat-msg-name">${msg.role === 'user' ? 'You' : 'AI'}</div>
      <div class="chat-msg-content${msg.isError ? ' error' : ''}">${
        msg.role === 'user' ? escapeHtml(msg.content) : (msg.content ? renderMarkdown(msg.content) : '')
      }</div>
    </div>
  `;
  container.appendChild(el);
  scrollTradingChat();
  return el;
}

function showTradingTypingIndicator() {
  const container = document.getElementById('tradingMessages');
  if (!container) return;
  const el = document.createElement('div');
  el.className = 'chat-message assistant';
  el.id = 'tradingTypingIndicator';
  el.innerHTML = `
    <div class="chat-msg-avatar">AI</div>
    <div class="chat-msg-body">
      <div class="chat-typing">
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
      </div>
    </div>
  `;
  container.appendChild(el);
  scrollTradingChat();
}

function removeTradingTypingIndicator() {
  document.getElementById('tradingTypingIndicator')?.remove();
}

function scrollTradingChat() {
  const el = document.getElementById('tradingMessages');
  if (el) el.scrollTop = el.scrollHeight;
}

function updateTradingSendButton() {
  const btn = document.getElementById('tradingSendBtn');
  if (btn) {
    btn.disabled = TRADING.isGenerating;
    btn.textContent = TRADING.isGenerating ? '...' : '\u2192';
  }
}

function saveTradingHistory() {
  try {
    const toSave = TRADING.conversations.slice(-10).map(c => ({
      id: c.id,
      messages: c.messages.slice(-50),
    }));
    localStorage.setItem('infinite_trading', JSON.stringify({ conversations: toSave, activeId: TRADING.activeId }));
  } catch {}
}

function loadTradingHistory() {
  try {
    const raw = localStorage.getItem('infinite_trading');
    if (!raw) return;
    const data = JSON.parse(raw);
    TRADING.conversations = data.conversations || [];
    TRADING.activeId = data.activeId;
  } catch {}
}

// ─── Tab: Tools Hub ───

function renderAgents() {
  const key = STATE.apiKeyFull || 'inf_your_key_here';
  const base = window.location.origin + '/proxy';

  const tools = [
    {
      category: 'AI Coding',
      items: [
        {
          name: 'aider',
          icon: '',
          desc: 'AI pair programming in your terminal. Edit code across entire repos with Claude or Gemini.',
          github: 'https://github.com/Aider-AI/aider',
          config: `# Install\npip install aider-chat\n\n# Run with INFINITE\nexport ANTHROPIC_API_KEY=${key}\nexport ANTHROPIC_BASE_URL=${base}\naider --model claude-sonnet-4-5-20250929`,
          status: 'LIVE',
        },
        {
          name: 'Continue',
          icon: '',
          desc: 'Open-source AI coding agent for VS Code & JetBrains. Autocomplete, chat, and edit in your IDE.',
          github: 'https://github.com/continuedev/continue',
          config: `// ~/.continue/config.json\n{\n  "models": [{\n    "provider": "anthropic",\n    "model": "claude-sonnet-4-5-20250929",\n    "apiKey": "${key}",\n    "apiBase": "${base}"\n  }]\n}`,
          status: 'LIVE',
        },
        {
          name: 'Open WebUI',
          icon: '',
          desc: 'Self-hosted ChatGPT-like interface. Connect to any LLM API with a beautiful web UI.',
          github: 'https://github.com/open-webui/open-webui',
          config: `# Docker setup\ndocker run -d -p 3000:8080 \\\n  -e OPENAI_API_BASE_URL=${base}/v1 \\\n  -e OPENAI_API_KEY=${key} \\\n  ghcr.io/open-webui/open-webui:main`,
          status: 'LIVE',
        },
        {
          name: 'Tabby',
          icon: '',
          desc: 'Self-hosted AI coding assistant. Open-source GitHub Copilot alternative — runs on consumer GPUs.',
          github: 'https://github.com/TabbyML/tabby',
          config: `# Docker setup\ndocker run -d -p 8080:8080 \\\n  tabbyml/tabby serve \\\n  --model TabbyML/StarCoder-1B\n\n# Connect to INFINITE for chat\n# Settings > Model > Custom API\n# Base URL: ${base}\n# API Key: ${key}`,
          status: 'LIVE',
        },
      ]
    },
    {
      category: 'AI Agents',
      items: [
        {
          name: 'CrewAI',
          icon: '',
          desc: 'Multi-agent AI framework. Build teams of AI agents that collaborate on complex tasks.',
          github: 'https://github.com/crewAIInc/crewAI',
          config: `# Install\npip install crewai\n\n# .env\nANTHROPIC_API_KEY=${key}\nANTHROPIC_BASE_URL=${base}\n\n# Usage\nfrom crewai import Agent, Crew\nagent = Agent(\n  role="Analyst",\n  llm="anthropic/claude-sonnet-4-5-20250929"\n)`,
          status: 'LIVE',
        },
        {
          name: 'LangChain',
          icon: '',
          desc: 'Build LLM-powered applications with chains, agents, and retrieval. Supports custom API endpoints.',
          github: 'https://github.com/langchain-ai/langchain',
          config: `pip install langchain-anthropic\n\nfrom langchain_anthropic import ChatAnthropic\n\nllm = ChatAnthropic(\n  model="claude-sonnet-4-5-20250929",\n  api_key="${key}",\n  base_url="${base}"\n)`,
          status: 'LIVE',
        },
        {
          name: 'AutoGPT',
          icon: '',
          desc: 'Autonomous AI agent platform. Create agents that complete tasks independently.',
          github: 'https://github.com/Significant-Gravitas/AutoGPT',
          config: `# .env in AutoGPT directory\nANTHROPIC_API_KEY=${key}\n\n# Configure in settings\n# Set Claude as your default model\n# Point API base to INFINITE proxy`,
          status: 'LIVE',
        },
        {
          name: 'Eliza (ElizaOS)',
          icon: '',
          desc: 'Web3-native AI agent framework with Solana support. Build agents that trade, chat, and execute on-chain.',
          github: 'https://github.com/elizaOS/eliza',
          config: `# .env\nANTHROPIC_API_KEY=${key}\nGOOGLE_GENERATIVE_AI_API_KEY=${key}\nSOLANA_PRIVATE_KEY=your_key\nSOLANA_RPC_URL=https://mainnet.helius-rpc.com\n\n# Install & run\nnpx eliza --character=your_agent.json`,
          status: 'LIVE',
        },
      ]
    },
    {
      category: 'Solana Trading',
      items: [
        {
          name: 'Copy Trading Bot',
          icon: '',
          desc: 'Mirror trades from any wallet in real-time. Uses Helius WebSocket for 0.3ms latency filtering.',
          github: 'https://github.com/metaggdev/Copy-trading-bot',
          config: `# .env\nHELIUS_API_KEY=your_helius_key\nRPC_URL=https://mainnet.helius-rpc.com\nPRIVATE_KEY=your_wallet_key\nTARGET_WALLET=wallet_to_copy\n\n# AI Analysis (uses your INFINITE key)\nANTHROPIC_API_KEY=${key}\nANTHROPIC_BASE_URL=${base}`,
          status: 'LIVE',
        },
        {
          name: 'Solana Sniper Bot',
          icon: '',
          desc: 'Automated token sniper for Raydium and Pump.fun. Configurable buy/sell logic with AI-assisted filtering.',
          github: 'https://github.com/fdundjer/solana-sniper-bot',
          config: `# .env\nRPC_ENDPOINT=https://mainnet.helius-rpc.com\nPRIVATE_KEY=your_key\nQUOTE_MINT=SOL\nQUOTE_AMOUNT=0.1\nAUTO_SELL=true\nSTOP_LOSS=30\nTAKE_PROFIT=50`,
          status: 'LIVE',
        },
        {
          name: 'Solana Trade Bot',
          icon: '',
          desc: 'Multi-DEX trading bot for Raydium, Pumpfun, Orca, Moonshot, and Jupiter with SDK integration.',
          github: 'https://github.com/YZYLAB/solana-trade-bot',
          config: `# .env\nSOLANA_RPC_URL=https://mainnet.helius-rpc.com\nPRIVATE_KEY=your_private_key\nSLIPPAGE=10\nPRIORITY_FEE=0.001`,
          status: 'LIVE',
        },
        {
          name: 'Solana Agent Kit',
          icon: '',
          desc: 'AI agent framework for Solana. Execute trades, check balances, and chain tools with natural language.',
          github: 'https://github.com/truemagic-coder/solana-agent',
          config: `# .env\nANTHROPIC_API_KEY=${key}\nANTHROPIC_BASE_URL=${base}\nSOLANA_RPC_URL=https://mainnet.helius-rpc.com\nPRIVATE_KEY=your_key`,
          status: 'LIVE',
        },
        {
          name: 'Pump.fun Sniper',
          icon: '',
          desc: 'Open-source Pump.fun sniper bot for new Solana token launches. Configurable buy/sell with priority fees.',
          github: 'https://github.com/TreeCityWes/Pump-Fun-Trading-Bot-Solana',
          config: `# .env\nSOLANA_RPC_URL=https://mainnet.helius-rpc.com\nWALLET_PRIVATE_KEY=your_key\nQUOTE_MINT=SOL\nPRIORITY_FEE=0.001\nSLIPPAGE=10`,
          status: 'LIVE',
        },
        {
          name: 'Multi-Tool Bot',
          icon: '',
          desc: 'All-in-one: Raydium sniper, Pumpfun bundler, volume bot, copy trading, and wallet tracker in one package.',
          github: 'https://github.com/Immutal0/solana-trading-bot',
          config: `# .env\nRPC_URL=https://mainnet.helius-rpc.com\nPRIVATE_KEYS=["your_key"]\nBOT_MODE=sniper\nTELEGRAM_BOT_TOKEN=optional\nSLIPPAGE=15`,
          status: 'LIVE',
        },
      ]
    },
  ];

  return `
    <div class="page-header">
      <h1 class="page-title">Tools Hub</h1>
      <p class="page-sub">Pre-configured tools with your API key auto-filled. Clone, paste config, run.</p>
    </div>
    ${tools.map(cat => `
      <div class="tools-section">
        <div class="section-title">${cat.category}</div>
        <div class="tools-grid">
          ${cat.items.map(t => `
            <div class="tool-card" style="cursor:default;">
              <div class="tool-header">
                <span class="tool-icon">${t.icon}</span>
                <span class="tool-status${t.status === 'SOON' ? ' coming' : ''}">${t.status}</span>
              </div>
              <div class="tool-name">${t.name}</div>
              <div class="tool-desc">${t.desc}</div>
              <div class="tool-config-box">${escapeHtml(t.config)}</div>
              <div class="tool-card-actions">
                <a href="#" onclick="copyText(${JSON.stringify(t.config).replace(/"/g, '&quot;')});return false;">Copy Config</a>
                <a href="${t.github}" target="_blank" rel="noopener">GitHub</a>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `).join('')}
  `;
}

// ─── Tab: Future APIs ───

const FUTURE_APIS = [
  // RPC/Infrastructure
  {
    id: 'helius',
    name: 'Helius',
    category: 'RPC/Infrastructure',
    logo: 'https://dashboard.helius.dev/logos/logo-helius.svg',
    description: 'Premier Solana RPC provider with enhanced APIs for NFT metadata, transaction parsing, webhooks, and Digital Asset Standard API.',
    features: ['RPC', 'Webhooks', 'DAS API', 'NFT Metadata'],
    website: 'https://helius.dev',
  },
  {
    id: 'quicknode',
    name: 'QuickNode',
    category: 'RPC/Infrastructure',
    logo: 'https://www.gitbook.com/cdn-cgi/image/width=40,dpr=2,height=40,fit=contain,format=auto/https%3A%2F%2F1578191620-files.gitbook.io%2F~%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252F-Mf3KXQJ21hOqcm3xf03%252Ficon%252FBVmzTIFKQxm5Kik0vItS%252FQuickNode%2520Icon%2520Blue.png%3Falt%3Dmedia%26token%3D4acb23b9-bd6e-4cd7-8a6d-4f1d1b0c0096',
    description: 'Multi-chain RPC infrastructure with Solana support. Add-ons for NFT APIs, token data, and marketplace information.',
    features: ['Multi-chain', 'Global Edge', 'Add-ons', 'Low Latency'],
    website: 'https://quicknode.com',
  },
  {
    id: 'alchemy',
    name: 'Alchemy',
    category: 'RPC/Infrastructure',
    logo: 'https://www.datocms-assets.com/105223/1749761632-logo.svg',
    description: 'Enterprise-grade blockchain infrastructure with Solana support. Enhanced APIs, webhooks, and developer tools.',
    features: ['Enterprise', 'Webhooks', 'Dev Tools', 'High Uptime'],
    website: 'https://alchemy.com',
  },
  {
    id: 'triton',
    name: 'Triton',
    category: 'RPC/Infrastructure',
    logo: 'https://triton.one/img/logo-triton-icon.png',
    description: 'High-performance Solana RPC provider known for validator infrastructure. Powers major Solana dApps.',
    features: ['High Performance', 'Validators', 'Dedicated RPC', 'Shared RPC'],
    website: 'https://triton.one',
  },
  // DeFi/Trading
  {
    id: 'jupiter',
    name: 'Jupiter',
    category: 'DeFi/Trading',
    logo: 'https://www.helius.dev/api/logos/file/logo-jupiter-1.svg',
    description: 'The leading Solana DEX aggregator. Routes trades across all major AMMs for best prices with swap, limit order, and DCA APIs.',
    features: ['DEX Aggregator', 'Limit Orders', 'DCA', 'Best Prices'],
    website: 'https://jup.ag',
  },
  {
    id: 'raydium',
    name: 'Raydium',
    category: 'DeFi/Trading',
    logo: 'https://www.helius.dev/api/logos/file/logo-raydium-1.svg',
    description: 'Major Solana AMM and liquidity provider. APIs for swaps, pools, and concentrated liquidity positions.',
    features: ['AMM', 'Liquidity Pools', 'CLMM', 'Swaps'],
    website: 'https://raydium.io',
  },
  {
    id: 'orca',
    name: 'Orca',
    category: 'DeFi/Trading',
    logo: 'https://www.helius.dev/api/logos/file/logo-orca.svg',
    description: 'User-friendly Solana DEX with concentrated liquidity (Whirlpools). SDKs for programmatic trading and liquidity provision.',
    features: ['Whirlpools', 'CLMM', 'SDK', 'User-Friendly'],
    website: 'https://orca.so',
  },
  {
    id: 'pumpfun',
    name: 'Pump.fun',
    category: 'DeFi/Trading',
    logo: 'https://www.helius.dev/api/logos/file/pump-fun-logo.svg',
    description: 'Popular token launchpad on Solana for memecoins. Essential for tracking new launches and early trading opportunities.',
    features: ['Token Launch', 'Memecoins', 'Bonding Curves', 'Early Access'],
    website: 'https://pump.fun',
  },
  // Data/Analytics
  {
    id: 'birdeye',
    name: 'Birdeye',
    category: 'Data/Analytics',
    logo: 'https://www.helius.dev/api/logos/file/birdeye-logo.svg',
    description: 'Comprehensive Solana token analytics. Real-time prices, OHLCV data, holder info, security analysis, and trending tokens.',
    features: ['Token Data', 'OHLCV', 'Security Scan', 'Trending'],
    website: 'https://birdeye.so',
  },
  {
    id: 'dexscreener',
    name: 'DexScreener',
    category: 'Data/Analytics',
    logo: 'https://www.helius.dev/api/logos/file/dexscreener-logo.svg',
    description: 'Multi-chain DEX analytics with excellent Solana coverage. Real-time charts, pair data, new listings, and trending tokens.',
    features: ['Multi-chain', 'Charts', 'New Listings', 'Trending'],
    website: 'https://dexscreener.com',
  },
  {
    id: 'defillama',
    name: 'DeFiLlama',
    category: 'Data/Analytics',
    logo: 'https://defillama.com/defillama-dark.png',
    description: 'Open/free API for DeFi TVL, yields, and protocol analytics across all chains. Essential for macro DeFi data.',
    features: ['TVL Data', 'Yields', 'Free API', 'Cross-chain'],
    website: 'https://defillama.com',
  },
  {
    id: 'coingecko',
    name: 'CoinGecko',
    category: 'Data/Analytics',
    logo: 'https://static.coingecko.com/s/coingecko-logo-8903d34ce19ca4be1c81f0db30e924154750d208683fad7ae6f2ce06c76d0a56.png',
    description: 'Major crypto data aggregator with token prices, market caps, volumes, and historical data. Free and pro tiers available.',
    features: ['Prices', 'Market Cap', 'Volume', 'Historical'],
    website: 'https://coingecko.com',
  },
  // NFT
  {
    id: 'magiceden',
    name: 'Magic Eden',
    category: 'NFT',
    logo: 'https://www.helius.dev/api/logos/file/logo-magiceden.svg',
    description: 'Largest Solana NFT marketplace. APIs for listings, sales, collections, and marketplace data for trading bots.',
    features: ['Marketplace', 'Listings', 'Sales Data', 'Collections'],
    website: 'https://magiceden.io',
  },
  {
    id: 'tensor',
    name: 'Tensor',
    category: 'NFT',
    logo: 'https://www.helius.dev/api/logos/file/logo-tensor-1.svg',
    description: 'Professional Solana NFT trading platform with AMM pools, bids, and real-time data. Growing API for pro traders.',
    features: ['Pro Trading', 'AMM Pools', 'Bids', 'Real-time'],
    website: 'https://tensor.trade',
  },
  {
    id: 'metaplex',
    name: 'Metaplex',
    category: 'NFT',
    logo: 'https://www.helius.dev/api/logos/file/logo-metaplex.svg',
    description: 'Core NFT infrastructure on Solana. Standards, tools, and APIs for creating and managing NFTs and digital assets.',
    features: ['NFT Standard', 'cNFTs', 'Tooling', 'Metadata'],
    website: 'https://metaplex.com',
  },
  // Social/Alerts
  {
    id: 'twitter',
    name: 'Twitter/X API',
    category: 'Social/Alerts',
    logo: 'https://abs.twimg.com/responsive-web/client-web/icon-ios.77d25eba.png',
    description: 'Essential for crypto social signals, influencer tracking, sentiment analysis, and automated posting.',
    features: ['Social Signals', 'Sentiment', 'Auto-Post', 'Influencers'],
    website: 'https://developer.twitter.com',
  },
  {
    id: 'telegram',
    name: 'Telegram Bot API',
    category: 'Social/Alerts',
    logo: 'https://telegram.org/img/t_logo.png',
    description: 'Free API for alert bots, trading notifications, community management, and conversational interfaces.',
    features: ['Bots', 'Alerts', 'Free', 'Communities'],
    website: 'https://core.telegram.org/bots/api',
  },
  {
    id: 'discord',
    name: 'Discord API',
    category: 'Social/Alerts',
    logo: 'https://www.helius.dev/api/logos/file/logo-discord-1.svg',
    description: 'Powers community bots for alerts, trading signals, and automated notifications. Essential for crypto communities.',
    features: ['Bots', 'Webhooks', 'Communities', 'Alerts'],
    website: 'https://discord.com/developers',
  },
  // Emerging
  {
    id: 'shyft',
    name: 'Shyft',
    category: 'Emerging',
    logo: 'https://shyft.to/assets/shyft-logo-symbol.png',
    description: 'Solana-focused API with transaction parsing, wallet tracking, token APIs, and webhooks. Growing Helius alternative.',
    features: ['Parsing', 'Wallets', 'Webhooks', 'Tokens'],
    website: 'https://shyft.to',
  },
  {
    id: 'hellomoon',
    name: 'Hello Moon',
    category: 'Emerging',
    logo: 'https://www.hellomoon.io/assets/hellomoon-logo.svg',
    description: 'Solana analytics and data API platform. Indexed blockchain data, NFT analytics, DeFi metrics, and wallet intelligence.',
    features: ['Analytics', 'Indexed Data', 'NFT Metrics', 'Wallets'],
    website: 'https://hellomoon.io',
  },
];

const API_CATEGORIES = ['All', 'RPC/Infrastructure', 'DeFi/Trading', 'Data/Analytics', 'NFT', 'Social/Alerts', 'Emerging'];

let selectedApiCategory = 'All';

function getApiVoteCount(apiId) {
  return VOTES.voteCounts[apiId] || 0;
}

function renderFutureApis() {
  const filteredApis = selectedApiCategory === 'All' 
    ? FUTURE_APIS 
    : FUTURE_APIS.filter(api => api.category === selectedApiCategory);
  
  const sortedApis = [...filteredApis].sort((a, b) => {
    return getApiVoteCount(b.id) - getApiVoteCount(a.id);
  });

  return `
    <div class="page-header">
      <h1 class="page-title">Future API Integrations</h1>
      <p class="page-sub">Vote for the APIs you want integrated into INFINITE Protocol</p>
    </div>
    <div class="future-apis-note">
      <strong style="color:var(--accent)">How it works:</strong> Upvote the APIs you'd like to see integrated. 
      The most requested APIs will be prioritized in our roadmap. Your vote helps shape the future of INFINITE.
    </div>
    <div class="future-apis-tabs">
      ${API_CATEGORIES.map(cat => `
        <button class="future-apis-tab ${selectedApiCategory === cat ? 'active' : ''}" onclick="filterApiCategory('${cat}')">${cat}</button>
      `).join('')}
    </div>
    <div class="future-apis-grid">
      ${sortedApis.map(api => {
        const voteCount = getApiVoteCount(api.id);
        const hasVoted = VOTES.userVotes.has(api.id);
        return `
          <div class="api-card">
            <div class="api-card-logo">
              <img src="${api.logo}" alt="${api.name}" onerror="this.style.display='none';this.parentElement.innerHTML='<div style=\\'width:48px;height:48px;background:var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent);font-size:18px;\\'>${api.name.charAt(0)}</div>'">
            </div>
            <div class="api-card-content">
              <div class="api-card-header">
                <div class="api-card-name">${api.name}</div>
                <div class="api-card-category">${api.category}</div>
              </div>
              <div class="api-card-desc">${api.description}</div>
              <div class="api-card-features">
                ${api.features.map(f => `<span class="api-card-feature">${f}</span>`).join('')}
              </div>
              <div class="api-card-footer">
                <a href="${api.website}" target="_blank" rel="noopener" class="api-card-link">${api.website.replace('https://', '')}</a>
                <button class="api-upvote-btn ${hasVoted ? 'voted' : ''}" onclick="toggleVote('${api.id}')">
                  <span class="arrow">${hasVoted ? '▲' : '△'}</span>
                  ${voteCount.toLocaleString()}
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

function filterApiCategory(category) {
  selectedApiCategory = category;
  render();
}

// ─── Tab: Treasury ───

function renderTreasury() {
  const t = STATE.treasury;
  const hasSol = t.treasuryBalanceSol > 0;
  const solDisplay = hasSol ? t.treasuryBalanceSol.toFixed(4) : '0';
  const usdDisplay = hasSol ? '$' + t.treasuryBalanceUsd.toLocaleString(undefined, { maximumFractionDigits: 2 }) : '$0';
  const priceDisplay = t.solPrice > 0 ? '$' + t.solPrice.toFixed(2) : '—';
  const statusColor = {
    surplus: 'var(--green)', healthy: 'var(--accent)', cautious: '#febc2e',
    critical: 'var(--red)', unknown: 'var(--text-muted)'
  }[t.healthStatus] || 'var(--text-muted)';
  return `
    <div class="page-header">
      <h1 class="page-title">Treasury</h1>
      <p class="page-sub">Live protocol treasury balance. Funded by pump.fun creator fees.</p>
    </div>
    <div class="stats-row">
      <div class="stat-card"><div class="label">SOL Balance</div><div class="value accent">${solDisplay}</div><div class="sub">${usdDisplay} USD${t.wallet ? ' &middot; ' + t.wallet : ''}</div></div>
      <div class="stat-card"><div class="label">SOL Price</div><div class="value">${priceDisplay}</div><div class="sub">via Jupiter</div></div>
      <div class="stat-card"><div class="label">Health Status</div><div class="value" style="color:${statusColor};text-transform:uppercase;">${t.healthStatus}</div><div class="sub">rate multiplier: ${t.multiplier}x</div></div>
      <div class="stat-card"><div class="label">Runway</div><div class="value">${t.runwayDays || '—'}</div><div class="sub">days at current usage</div></div>
    </div>
    <div class="section">
      <div class="section-title">How Treasury Works</div>
      <div class="api-key-box">
        <div class="api-key-hint" style="line-height:2;">
          Creator fees from the $INFINITE token on pump.fun are split:<br>
          <strong style="color:var(--text)">50%</strong> - API treasury (pays for Claude + Gemini calls)<br>
          <strong style="color:var(--text)">40%</strong> - Dev operations<br>
          <strong style="color:var(--text)">10%</strong> - Community fund<br><br>
          You claim fees and move them to the treasury wallet. The balance updates every 5 minutes.
        </div>
      </div>
    </div>
  `;
}

// ─── Event Binding ───

function bindEvents() {
  document.querySelectorAll('.nav-item[data-tab]').forEach(item => {
    item.addEventListener('click', () => setTab(item.dataset.tab));
  });
  document.querySelectorAll('[data-provider]').forEach(btn => {
    btn.addEventListener('click', () => {
      const idx = parseInt(btn.dataset.provider);
      const providers = getWalletProviders();
      if (providers[idx]) connectWallet(providers[idx].provider);
    });
  });

  // Chat-specific bindings
  const chatInput = document.getElementById('chatInput');
  if (chatInput) {
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendChatMessage();
      }
    });
    chatInput.addEventListener('input', () => {
      chatInput.style.height = 'auto';
      chatInput.style.height = Math.min(chatInput.scrollHeight, 200) + 'px';
    });
  }

  const chatSendBtn = document.getElementById('chatSendBtn');
  if (chatSendBtn) {
    chatSendBtn.addEventListener('click', () => sendChatMessage());
  }

  const modelSelect = document.getElementById('chatModelSelect');
  if (modelSelect) {
    modelSelect.addEventListener('change', () => { CHAT.selectedModel = modelSelect.value; });
  }

  const convSelect = document.getElementById('chatConvSelect');
  if (convSelect) {
    convSelect.addEventListener('change', () => {
      CHAT.activeId = convSelect.value;
      render();
    });
  }

  // Tool toggles
  function bindToolToggle(elementId, toolName) {
    const btn = document.getElementById(elementId);
    if (btn) {
      btn.addEventListener('click', () => {
        const idx = CHAT.enabledTools.indexOf(toolName);
        if (idx >= 0) CHAT.enabledTools.splice(idx, 1);
        else CHAT.enabledTools.push(toolName);
        btn.classList.toggle('active', CHAT.enabledTools.includes(toolName));
      });
    }
  }
  bindToolToggle('searchToggle', 'web_search');
  bindToolToggle('urlReaderToggle', 'url_reader');
  bindToolToggle('codeRunnerToggle', 'code_runner');
  bindToolToggle('githubToggle', 'github_lookup');
  bindToolToggle('googleToggle', 'google_lookup');
  bindToolToggle('notionToggle', 'notion_lookup');

  // Upload button + file input
  const uploadBtn = document.getElementById('chatUploadBtn');
  const fileInput = document.getElementById('chatFileInput');
  if (uploadBtn && fileInput) {
    uploadBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      handleImageUpload(e.target.files);
      fileInput.value = '';
    });
  }

  // Connectors button — navigate to connections tab
  const connectorsBtn = document.getElementById('chatConnectorsBtn');
  if (connectorsBtn) {
    connectorsBtn.addEventListener('click', () => {
      STATE.activeTab = 'connections';
      render();
    });
  }

  // Trading-specific bindings
  const tradingInput = document.getElementById('tradingInput');
  if (tradingInput) {
    tradingInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendTradingMessage();
      }
    });
    tradingInput.addEventListener('input', () => {
      tradingInput.style.height = 'auto';
      tradingInput.style.height = Math.min(tradingInput.scrollHeight, 200) + 'px';
    });
  }

  const tradingSendBtn = document.getElementById('tradingSendBtn');
  if (tradingSendBtn) {
    tradingSendBtn.addEventListener('click', () => sendTradingMessage());
  }

  const tradingModelSelect = document.getElementById('tradingModelSelect');
  if (tradingModelSelect) {
    tradingModelSelect.addEventListener('change', () => { TRADING.selectedModel = tradingModelSelect.value; });
  }

  bindCodeCopyButtons();
}

// ─── Init ───

loadChatHistory();
loadVideoHistory();
loadTradingHistory();
if (loadSession()) {
  if (STATE.models.length && !CHAT.selectedModel) CHAT.selectedModel = STATE.models[0];
  if (STATE.models.length && !TRADING.selectedModel) TRADING.selectedModel = STATE.models[0];
  startStatusPolling();
}

// Handle OAuth redirects
const urlParams = new URLSearchParams(window.location.search);
const connectedProvider = urlParams.get('connected');
const oauthError = urlParams.get('oauth_error');
if (connectedProvider) {
  STATE.connections[connectedProvider] = true;
  STATE.activeTab = 'connections';
  showToast(`${connectedProvider} connected successfully`);
  fetchOAuthStatus();
  window.history.replaceState({}, '', '/dashboard');
} else if (oauthError) {
  showToast(`OAuth error: ${oauthError}`, true);
  window.history.replaceState({}, '', '/dashboard');
}

render();
</script>

</body>
</html>
